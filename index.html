<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Internal ERP ‚Äî Invoices ‚Ä¢ Books ‚Ä¢ Bank ‚Ä¢ Audit</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="description" content="Single-file ERP: LocalStorage JSON CRUD, import/export, reconciliation, reports (aging), CSV/PDF export, dashboard.">
<style>
:root{
  --bg:#0b1220;--panel:#0f172a;--muted:#0c152a;--text:#e5e7eb;--sub:#9ca3af;
  --accent:#22d3ee;--violet:#a78bfa;--ok:#22c55e;--warn:#f59e0b;--bad:#ef4444;
  --chip:#1f2937;--row:#0a1222;--border:#1e293b;--shadow:0 6px 24px rgba(0,0,0,.25);
  --surface-strong:#0b152a;--surface-soft:#0b1426;--input-bg:#081120;
  --top-bg:linear-gradient(180deg,#0f172a,#0c1426);--btn-bg:linear-gradient(180deg,#1f2937,#0f172a);
  --btn-border:#1e293b;--btn-text:var(--text);--btn-pri-bg:linear-gradient(180deg,#0ea5e9,#0284c7);
  --btn-pri-border:#0369a1;--row-hover:#0d1b31;
}
[data-theme="light"]{
  --bg:#f8fafc;--panel:#ffffff;--muted:#f1f5f9;--text:#0f172a;--sub:#475569;
  --accent:#0284c7;--violet:#6366f1;--ok:#15803d;--warn:#b45309;--bad:#b91c1c;
  --chip:#e2e8f0;--row:#f8fafc;--border:#cbd5f5;--shadow:0 6px 20px rgba(15,23,42,.12);
  --surface-strong:#e2e8f0;--surface-soft:#f8fafc;--input-bg:#ffffff;
  --top-bg:linear-gradient(180deg,#e2e8f0,#f8fafc);--btn-bg:linear-gradient(180deg,#e2e8f0,#cbd5f5);
  --btn-border:#cbd5f5;--btn-text:#0f172a;--btn-pri-bg:linear-gradient(180deg,#38bdf8,#0ea5e9);
  --btn-pri-border:#0284c7;--row-hover:#e2e8f0;
}
*{box-sizing:border-box}
html,body{margin:0;background:var(--bg);color:var(--text);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji"}
a{color:var(--accent);text-decoration:none}
a:hover{text-decoration:underline}
.app{min-height:100vh;display:flex;flex-direction:column}
.top{position:sticky;top:0;z-index:50;display:flex;gap:.8rem;align-items:center;padding:.8rem 1rem;background:var(--top-bg);border-bottom:1px solid var(--border);box-shadow:var(--shadow)}
.logo{width:36px;height:36px;border-radius:10px;background:radial-gradient(12px 12px at 30% 30%,var(--accent),transparent 70%),radial-gradient(12px 12px at 70% 70%,var(--violet),transparent 70%),#081120}
.title{font-weight:800}
.tiny{color:var(--sub);font-size:.82rem}
.sp{flex:1}
.chip{background:var(--chip);color:var(--sub);padding:.2rem .5rem;border:1px solid var(--border);border-radius:999px;font-size:.74rem}
.main{display:grid;grid-template-columns:240px 1fr;gap:1rem;padding:1rem}
.side{position:sticky;top:68px;height:calc(100vh - 84px);overflow:auto;border-right:1px solid var(--border)}
.nav{display:flex;flex-direction:column}
.nav button{appearance:none;text-align:left;background:none;border:none;color:var(--text);padding:.75rem 1rem;border-bottom:1px solid var(--border);cursor:pointer}
.nav button:hover,.nav button.active{background:var(--muted)}
.panel{background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:1rem;box-shadow:var(--shadow)}
.grid{display:grid;gap:1rem}
.g12{grid-template-columns:repeat(12,1fr)}
.kpi{grid-column:span 3;background:var(--surface-strong);border:1px solid var(--border);border-radius:14px;padding:1rem}
.kpi .lbl{color:var(--sub);font-size:.9rem}
.kpi .val{font-size:1.4rem;font-weight:800;margin-top:.25rem}
.kpi .delta{font-size:.9rem;margin-top:.25rem}
.ok{color:#86efac}.warn{color:#fde68a}.bad{color:#fecaca}
.bar{display:flex;flex-wrap:wrap;gap:.5rem;align-items:center;margin:.5rem 0 1rem}
.grp{display:flex;gap:.5rem;align-items:center;background:var(--surface-soft);border:1px solid var(--border);padding:.5rem;border-radius:10px}
.bar input,.bar select,.bar textarea{background:var(--input-bg);color:var(--text);border:1px solid var(--border);padding:.5rem .6rem;border-radius:8px}
.btn{background:var(--btn-bg);color:var(--btn-text);border:1px solid var(--btn-border);padding:.55rem .8rem;border-radius:8px;cursor:pointer}
.btn.pri{background:var(--btn-pri-bg);border-color:var(--btn-pri-border);color:#fff}
.theme-toggle{font-size:.85rem;display:flex;align-items:center;gap:.35rem;padding:.45rem .75rem}
.wrap{overflow:auto;border:1px solid var(--border);border-radius:12px}
.col-menu-wrap{position:relative}
.col-menu{position:absolute;top:calc(100% + .4rem);right:0;min-width:220px;max-height:320px;overflow:auto;background:var(--surface-strong);border:1px solid var(--border);border-radius:12px;box-shadow:var(--shadow);padding:.6rem;display:none;z-index:40}
.col-menu.open{display:block}
.col-menu-list label{display:flex;align-items:center;gap:.5rem;font-size:.85rem;margin:.25rem 0}
.col-menu-list input{margin:0}
.col-menu-actions{margin-top:.6rem;display:flex;justify-content:flex-end}
.col-menu-actions .btn{width:100%}
table{width:100%;border-collapse:collapse}
th,td{text-align:left;padding:.6rem .55rem;border-bottom:1px solid var(--border);vertical-align:top}
thead th{position:sticky;top:0;background:var(--panel);border-bottom:1px solid var(--border);cursor:pointer}
tbody tr:nth-child(odd){background:var(--row)}
tbody tr:hover{background:var(--row-hover)}
.status{padding:.15rem .5rem;border-radius:8px;font-size:.75rem;border:1px solid var(--border);background:var(--chip);display:inline-block}
.status.ok{background:rgba(34,197,94,.12);color:#86efac;border-color:rgba(34,197,94,.25)}
.status.warn{background:rgba(245,158,11,.12);color:#facc15;border-color:rgba(245,158,11,.25)}
.status.bad{background:rgba(239,68,68,.12);color:#fb7185;border-color:rgba(239,68,68,.25)}
.mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}
.right{margin-left:auto}.hidden{display:none!important}
.note{color:#fde68a;background:rgba(245,158,11,.08);border:1px solid rgba(245,158,11,.25);padding:.35rem .5rem;border-radius:8px}
.succ{color:#bbf7d0;background:rgba(34,197,94,.08);border:1px solid rgba(34,197,94,.25);padding:.35rem .5rem;border-radius:8px}
.dang{color:#fecaca;background:rgba(239,68,68,.08);border:1px solid rgba(239,68,68,.25);padding:.35rem .5rem;border-radius:8px}
.modal{position:fixed;inset:0;display:none;place-items:center;background:rgba(0,0,0,.55);z-index:100}
.modal.open{display:grid}
.card{width:min(760px,95vw);background:var(--panel);border:1px solid var(--border);border-radius:14px;box-shadow:var(--shadow);padding:1rem}
.form{display:grid;grid-template-columns:1fr 1fr;gap:.6rem}
.form label{font-size:.85rem;color:var(--sub)}
.form input,.form select,.form textarea{width:100%;background:var(--input-bg);color:var(--text);border:1px solid var(--border);border-radius:8px;padding:.5rem}
.actions{display:flex;gap:.5rem;justify-content:flex-end;margin-top:.8rem}
.footer{padding:1rem;color:var(--sub);text-align:center;border-top:1px solid var(--border)}
@media (max-width:1024px){.main{grid-template-columns:1fr}.side{position:static;height:auto;border-right:none}.kpi{grid-column:span 6}}
@media (max-width:640px){.kpi{grid-column:span 12}.form{grid-template-columns:1fr}}
</style>
</head>
<body>
<div class="app">
  <header class="top">
    <div class="logo" aria-hidden="true"></div>
    <div>
      <div class="title">Internal ERP</div>
      <div class="tiny">Invoices ¬∑ Accounting Books ¬∑ Bank ¬∑ Audit</div>
    </div>
    <span class="sp"></span>
    <button id="themeToggle" class="btn theme-toggle" type="button" aria-label="Switch to light mode">‚òÄÔ∏è Light</button>
    <span id="env" class="chip">LocalStorage</span>
  </header>

  <div class="main">
    <aside class="side">
      <nav class="nav" id="nav">
        <button data-tab="dash" class="active">üè† Dashboard</button>
        <button data-tab="sales">üßæ Sales</button>
        <button data-tab="purch">üì• Purchases</button>
        <button data-tab="bank">üè¶ Bank</button>
        <button data-tab="reports">üìä Reports</button>
        <button data-tab="audit">üîé Audit</button>
        <button data-tab="data">‚öôÔ∏è Data</button>
      </nav>
    </aside>

    <main>
      <!-- DASHBOARD -->
      <section id="dash" class="panel">
        <div class="grid g12">
          <div class="kpi"><div class="lbl">Sales (This Month)</div><div class="val" id="kpiSalesCnt">‚Äî</div><div class="delta ok" id="kpiSalesSum">‚Ç¨ ‚Äî</div></div>
          <div class="kpi"><div class="lbl">Unpaid Sales</div><div class="val" id="kpiUnpaidCnt">‚Äî</div><div class="delta warn" id="kpiUnpaidSum">‚Ç¨ ‚Äî</div></div>
          <div class="kpi"><div class="lbl">Purchases (This Month)</div><div class="val" id="kpiPurchCnt">‚Äî</div><div class="delta" id="kpiPurchSum">‚Ç¨ ‚Äî</div></div>
          <div class="kpi"><div class="lbl">Unreconciled Bank</div><div class="val" id="kpiBankOpen">‚Äî</div><div class="delta bad" id="kpiBankSum">‚Ç¨ ‚Äî</div></div>
        </div>
        <div class="bar">
          <span id="qcDup" class="chip">Duplicates: ‚Äî</span>
          <span id="qcGap" class="chip">Numbering gaps: ‚Äî</span>
          <span id="qcOrph" class="chip">Orphans (no bank): ‚Äî</span>
          <span class="right tiny">Last refresh: <span id="lastRef">‚Äî</span></span>
        </div>
        <div class="wrap">
          <table id="aging">
            <thead><tr><th>Customer</th><th class="mono">Current</th><th class="mono">1‚Äì30</th><th class="mono">31‚Äì60</th><th class="mono">61‚Äì90</th><th class="mono">90+</th><th class="mono">Total</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </section>

      <!-- SALES -->
      <section id="sales" class="panel hidden">
        <div class="bar">
          <div class="grp">
            <input id="sQ" placeholder="Search (invoice, customer, notes)‚Ä¶">
            <input id="sFrom" type="date"><input id="sTo" type="date">
            <select id="sSt"><option value="">Any</option><option>paid</option><option>unpaid</option><option>partial</option></select>
          </div>
          <div class="grp">
            <button class="btn" id="sAdd">+ New</button>
            <button class="btn" id="sEdit">Edit</button>
            <button class="btn" id="sDel">Delete</button>
          </div>
          <div class="grp">
            <button class="btn pri" id="sCSV">Export CSV</button>
            <button class="btn" id="sPDF">Export PDF</button>
            <button class="btn" id="sOpenPDF">Open PDF</button>
          </div>
          <span class="tiny">Click a row to select ‚Ä¢ Click headers to sort</span>
        </div>
        <div class="wrap">
          <table id="sTbl">
            <thead>
              <tr>
                <th data-k="invoice_no">Invoice #</th>
                <th data-k="date">Date</th>
                <th data-k="customer">Customer</th>
                <th data-k="amount" class="mono">Amount</th>
                <th data-k="status">Status</th>
                <th data-k="paid_date">Paid Date</th>
                <th data-k="pdf_link">PDF</th>
                <th data-k="notes">Notes</th>
              </tr>
            </thead><tbody></tbody>
          </table>
        </div>
      </section>

      <!-- PURCHASES -->
      <section id="purch" class="panel hidden">
        <div class="bar">
          <div class="grp">
            <input id="pQ" placeholder="Search (invoice, supplier)‚Ä¶">
            <input id="pFrom" type="date"><input id="pTo" type="date">
            <select id="pSt"><option value="">Any</option><option>paid</option><option>unpaid</option><option>partial</option></select>
          </div>
          <div class="grp">
            <button class="btn" id="pAdd">+ New</button>
            <button class="btn" id="pEdit">Edit</button>
            <button class="btn" id="pDel">Delete</button>
          </div>
          <div class="grp col-menu-wrap">
            <button class="btn" id="pColBtn" type="button" aria-expanded="false" aria-controls="pColMenu">Columns</button>
            <div id="pColMenu" class="col-menu" role="menu" aria-hidden="true">
              <div class="tiny" style="margin-bottom:.4rem">Toggle purchase columns</div>
              <div id="pColList" class="col-menu-list"></div>
              <div class="col-menu-actions">
                <button class="btn" type="button" id="pColShowAll">Show all</button>
              </div>
            </div>
          </div>
          <div class="grp">
            <button class="btn pri" id="pCSV">Export CSV</button>
            <button class="btn" id="pPDF">Export PDF</button>
            <button class="btn" id="pOpenPDF">Open PDF</button>
          </div>
          <span class="tiny">Supplier invoices</span>
        </div>
        <div class="wrap">
          <table id="pTbl">
            <thead><tr id="pHead"></tr></thead><tbody></tbody>
          </table>
        </div>
      </section>

      <!-- BANK -->
      <section id="bank" class="panel hidden">
        <div class="bar">
          <div class="grp">
            <input id="bQ" placeholder="Search (desc, invoice)‚Ä¶">
            <input id="bFrom" type="date"><input id="bTo" type="date">
            <select id="bType"><option value="">Any</option><option>credit</option><option>debit</option></select>
          </div>
          <div class="grp">
            <button class="btn" id="bAdd">+ New</button>
            <button class="btn" id="bEdit">Edit</button>
            <button class="btn" id="bDel">Delete</button>
          </div>
          <div class="grp">
            <button class="btn pri" id="bRecon">Auto-Match</button>
            <button class="btn" id="bCSV">Export CSV</button>
            <button class="btn" id="bPDF">Export PDF</button>
            <span id="bStats" class="chip">‚Äî</span>
          </div>
        </div>
        <div class="grid" style="grid-template-columns:1fr 1fr;gap:1rem">
          <div class="panel">
            <div style="display:flex;align-items:center;gap:.5rem">
              <div class="title" style="font-size:1rem">Bank Transactions</div>
              <span id="bOpen" class="chip right">Open: ‚Äî</span>
            </div>
            <div class="wrap">
              <table id="bTbl">
                <thead>
                  <tr>
                    <th data-k="execution_date">F. ejecuci√≥n</th>
                    <th data-k="value_date">F. valor</th>
                    <th data-k="concept">Concepto</th>
                    <th data-k="amount" class="mono">Importe</th>
                    <th data-k="balance" class="mono">Saldo</th>
                    <th data-k="invoice_no">FACTURA</th>
                    <th data-k="details">Desglose</th>
                    <th data-k="match_status">Match</th>
                  </tr>
                </thead><tbody></tbody>
              </table>
            </div>
          </div>
          <div class="panel">
            <div class="title" style="font-size:1rem">Suggested Matches</div>
            <div class="tiny">Run Auto-Reconcile to populate matches, then click Apply.</div>
            <div id="bSug" class="grid" style="grid-template-columns:1fr;gap:.6rem;margin-top:.5rem"></div>
          </div>
        </div>
      </section>

      <!-- REPORTS -->
      <section id="reports" class="panel hidden">
        <div class="bar">
          <div class="grp">
            <label class="tiny">Period</label>
            <input id="rFrom" type="date"><input id="rTo" type="date">
          </div>
          <div class="grp">
            <select id="rType">
              <option value="sales">Sales Summary</option>
              <option value="purch">Purchases Summary</option>
              <option value="aging">Receivables Aging</option>
              <option value="bank">Bank Summary</option>
            </select>
          </div>
          <div class="grp">
            <button class="btn pri" id="rRun">Run</button>
            <button class="btn" id="rCSV">Export CSV</button>
            <button class="btn" id="rPDF">Export PDF</button>
          </div>
          <span class="tiny">Reports run on in-memory data</span>
        </div>
        <div class="wrap">
          <table id="rTbl"><thead><tr><th>Field</th><th>Value</th></tr></thead><tbody></tbody></table>
        </div>
      </section>

      <!-- AUDIT -->
      <section id="audit" class="panel hidden">
        <div class="grid g12">
          <div class="kpi"><div class="lbl">Duplicate Invoices</div><div class="val" id="aDup">‚Äî</div><div class="tiny" id="aDupEx">‚Äî</div></div>
          <div class="kpi"><div class="lbl">Numbering Gaps</div><div class="val" id="aGap">‚Äî</div><div class="tiny" id="aGapEx">‚Äî</div></div>
          <div class="kpi"><div class="lbl">Orphan Sales (no bank)</div><div class="val" id="aOrph">‚Äî</div><div class="tiny" id="aOrphEx">‚Äî</div></div>
          <div class="kpi"><div class="lbl">Partial Payments</div><div class="val" id="aPart">‚Äî</div><div class="tiny" id="aPartEx">‚Äî</div></div>
        </div>
        <div class="bar">
          <button class="btn pri" id="aCSV">Export Issues CSV</button>
          <button class="btn" id="aPDF">Export Issues PDF</button>
          <span class="note">Issues computed from current data.</span>
        </div>
        <div class="wrap">
          <table id="aTbl">
            <thead><tr><th>Category</th><th>Reference</th><th>Detail</th><th>Suggested Action</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </section>

      <!-- DATA -->
      <section id="data" class="panel hidden">
        <div class="title" style="font-size:1rem">Data & Settings</div>
        <div class="bar">
          <div class="grp"><div class="tiny">Import JSON</div><input type="file" id="fImp" accept=".json"></div>
          <div class="grp"><button class="btn pri" id="dSave">Save to LocalStorage</button><button class="btn" id="dLoad">Load from LocalStorage</button><button class="btn" id="dClear">Clear LocalStorage</button></div>
          <div class="grp"><button class="btn pri" id="dExport">Export JSON Bundle</button></div>
          <span class="tiny right">Tip: commit a <span class="mono">/data/*.json</span> set and load via Settings &ldquo;Load from LocalStorage&rdquo; after importing.</span>
        </div>
        <div class="succ">Local-first. Nothing leaves your browser.</div>
        <div class="bar" style="margin-top:1rem">
          <div class="grp"><div class="tiny">Import supplier invoices (.xlsx)</div><input type="file" id="supFile" accept=".xlsx,.xls,.csv"></div>
          <div class="grp"><button class="btn pri" id="supTemplate">Download template</button><button class="btn" id="supClear">Clear imported</button></div>
          <span class="tiny right">Imported rows: <span id="supCount">0</span></span>
        </div>
        <div class="bar" style="margin-top:1rem">
          <div class="grp"><div class="tiny">Import bank movements (.xlsx)</div><input type="file" id="bankFile" accept=".xlsx,.xls,.csv"></div>
          <div class="grp"><button class="btn" id="bankClear">Clear imported bank</button></div>
          <span class="tiny right">Imported bank rows: <span id="bankCount">0</span></span>
        </div>
        <div class="wrap" style="margin-top:1rem">
          <table id="supTbl">
            <thead><tr id="supHead"></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </section>
    </main>
  </div>

  <footer class="footer">¬© <span id="yr"></span> Internal ERP ‚Äî Single-file</footer>
</div>

<!-- EDIT MODAL -->
<div class="modal" id="modal" role="dialog" aria-modal="true">
  <div class="card">
    <div class="title" id="mTitle" style="font-size:1.05rem">Edit</div>
    <div class="form" id="mForm"></div>
    <div class="actions">
      <button class="btn" id="mCancel">Cancel</button>
      <button class="btn pri" id="mSave">Save</button>
    </div>
  </div>
</div>

<script>
/* ===== Utilities ===== */
const $=s=>document.querySelector(s), $$=s=>Array.from(document.querySelectorAll(s));
const fmt = new Intl.NumberFormat(undefined,{style:"currency",currency:"EUR"});
const num = v => (typeof v==="number"?v:(v?Number(String(v).replace(/[^0-9.-]/g,"")):0));
const iso = d => (d?new Date(d).toISOString().slice(0,10):"");
const today = ()=>iso(new Date());
const by=(k,dir=1)=>(a,b)=>a[k]===b[k]?0:(a[k]>b[k]?dir:-dir);
const csvCell = s=>`"${String(s??"").replace(/"/g,'""')}"`;
const htmlEsc = str => String(str??"").replace(/[&<>"']/g, ch=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[ch]||ch));
const deb=(fn,ms=160)=>{let t;return(...a)=>{clearTimeout(t);t=setTimeout(()=>fn(...a),ms);}};
const invKey=v=>(v??"").toString().trim().toUpperCase();
const XLSX_SRC = "https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js";
let xlsxLoader=null;
function ensureXLSX(){
  if(window.XLSX) return Promise.resolve(window.XLSX);
  if(xlsxLoader) return xlsxLoader;
  xlsxLoader=new Promise((resolve,reject)=>{
    const script=document.createElement("script");
    script.src=XLSX_SRC;
    script.async=true;
    script.onload=()=> window.XLSX?resolve(window.XLSX):reject(new Error("XLSX global missing"));
    script.onerror=()=>reject(new Error("Failed to download XLSX library"));
    document.head.appendChild(script);
  }).catch(err=>{ xlsxLoader=null; throw err; });
  return xlsxLoader;
}

const BANK_IMPORT_SOURCE = "bank_import";
const BANK_HEADER_MAP = {
  f_ejecucion:"execution_date",
  f_valor:"value_date",
  concepto:"concept",
  importe:"amount",
  saldo:"balance",
  factura:"invoice",
  desglose:"details"
};
const BANK_HEADER_LABELS = {
  f_ejecucion:"F. ejecuci√≥n",
  f_valor:"F. valor",
  concepto:"Concepto",
  importe:"Importe",
  saldo:"Saldo",
  factura:"FACTURA",
  desglose:"Desglose"
};
const BANK_REQUIRED_HEADERS = Object.keys(BANK_HEADER_LABELS);
const BANK_HEADER_REVERSE = Object.fromEntries(Object.entries(BANK_HEADER_MAP).map(([k,v])=>[v,k]));

/* ===== State ===== */
const LS_KEYS = {sales:"erp_sales",purch:"erp_purch",bank:"erp_bank",suppliers:"erp_suppliers"};
const PURCH_COL_PREF_KEY = "erp_purch_hidden_cols";
const THEME_KEY = "erp_theme";
const State = {
  sales:[], purch:[], bank:[], suppliers:[],
  sel:{sales:null,purch:null,bank:null},
  sort:{sales:{k:"date",d:-1},purch:{k:"date",d:-1},bank:{k:"value_date",d:-1}},
  filter:{
    sales:{q:"",from:"",to:"",st:""},
    purch:{q:"",from:"",to:"",st:""},
    bank:{q:"",from:"",to:"",type:""}
  },
  hidden:{purch:new Set()},
  cfg:{reconDays:5}
};

/* ===== LocalStorage ===== */
function saveLS(){
  localStorage.setItem(LS_KEYS.sales, JSON.stringify(State.sales));
  localStorage.setItem(LS_KEYS.purch, JSON.stringify(State.purch));
  localStorage.setItem(LS_KEYS.bank, JSON.stringify(State.bank));
  localStorage.setItem(LS_KEYS.suppliers, JSON.stringify(State.suppliers));
  savePurchHiddenColumns();
  $("#env").textContent="LocalStorage (saved)";
}
function loadLS(){
  State.sales = JSON.parse(localStorage.getItem(LS_KEYS.sales) || "[]");
  State.purch = JSON.parse(localStorage.getItem(LS_KEYS.purch) || "[]");
  State.bank  = JSON.parse(localStorage.getItem(LS_KEYS.bank)  || "[]");
  State.suppliers = JSON.parse(localStorage.getItem(LS_KEYS.suppliers) || "[]");
  loadPurchHiddenColumns();
  if(!(State.sales.length||State.purch.length||State.bank.length||State.suppliers.length)){
    $("#env").textContent="Empty dataset";
  } else $("#env").textContent="LocalStorage (loaded)";
  syncPurchFromSuppliers();
  refreshAll();
}
function clearLS(){ localStorage.removeItem(LS_KEYS.sales);localStorage.removeItem(LS_KEYS.purch);localStorage.removeItem(LS_KEYS.bank);localStorage.removeItem(LS_KEYS.suppliers);localStorage.removeItem(PURCH_COL_PREF_KEY); State.hidden.purch.clear(); render.purch(); $("#env").textContent="LocalStorage (cleared)";}

/* ===== Import/Export JSON ===== */
function exportJSON(){
  const data = {sales:State.sales,purch:State.purch,bank:State.bank,suppliers:State.suppliers, exported_at:new Date().toISOString()};
  download("erp_bundle.json", JSON.stringify(data,null,2), "application/json");
}
function importJSONFile(file){
  const fr=new FileReader();
  fr.onload=()=>{
    try{
      const j=JSON.parse(fr.result);
      if(Array.isArray(j)) { /* accept array of sales */ State.sales = j; }
      else{
        if(Array.isArray(j.sales)) State.sales=j.sales;
        if(Array.isArray(j.purch)) State.purch=j.purch;
        if(Array.isArray(j.bank))  State.bank=j.bank;
        if(Array.isArray(j.suppliers)) State.suppliers=j.suppliers;
      }
      syncPurchFromSuppliers();
      refreshAll();
      $("#env").textContent="Imported (unsaved)";
    }catch(e){ alert("Invalid JSON: "+e.message); }
  };
  fr.readAsText(file);
}

/* ===== Helpers ===== */
function stamp(){ $("#lastRef").textContent=new Date().toLocaleString(); $("#yr").textContent=new Date().getFullYear(); }
function setActive(tab){ $$("#nav button").forEach(b=>b.classList.toggle("active",b.dataset.tab===tab)); $$("main > section").forEach(s=>s.classList.toggle("hidden", s.id!==tab)); }
function refreshAll({forceReports=false}={}){
  renderAll();
  resetReconSuggestions();
  if(forceReports || !$("#reports").classList.contains("hidden")) runReport();
  stamp();
}
function clickSort(tbl,stateKey){
  $(`#${tbl} thead`).addEventListener("click",e=>{
    if(e.target.tagName!=="TH")return;
    const k=e.target.dataset.k; if(!k)return;
    const s=State.sort[stateKey]; s.d = (s.k===k? -s.d : 1); s.k=k;
    render[stateKey]();
  });
}
function selectRow(tbody, stateKey){
  tbody.querySelectorAll("tr").forEach(tr=>tr.addEventListener("click",()=>{
    tbody.querySelectorAll("tr").forEach(r=>r.style.outline="");
    tr.style.outline="2px solid var(--accent)";
    const idx=+tr.dataset.i; State.sel[stateKey]=filtered[stateKey]()[idx]; // store by filtered index
  }));
}
function csvDownload(name, headers, rows){
  const head = headers.map(h=>csvCell(h.label)).join(",")+"\n";
  const body = rows.map(r=> headers.map(h=>csvCell(h.get(r))).join(",")).join("\n");
  download(name, head+body, "text/csv");
}
function download(name,content,mime){
  const a=document.createElement("a"); a.href=URL.createObjectURL(new Blob([content],{type:mime})); a.download=name; a.click(); URL.revokeObjectURL(a.href);
}
function printTableAsPDF(title, table){
  const w=window.open("","_blank","width=1024,height=768");
  w.document.write(`<html><head><title>${title}</title><style>
    body{font-family:Arial,Helvetica,sans-serif;padding:16px} table{width:100%;border-collapse:collapse}
    th,td{border:1px solid #ccc;padding:6px;text-align:left} thead{background:#eee}
  </style></head><body><h2>${title}</h2>${table.outerHTML}</body></html>`);
  w.document.close(); w.focus(); w.print();
}

function normalizeExcelDate(v){
  if(v==null||v==="") return "";
  if(v instanceof Date) return iso(v);
  if(typeof v==="number" && window.XLSX?.SSF?.parse_date_code){
    const d=XLSX.SSF.parse_date_code(v);
    if(d){
      const dt=new Date(Date.UTC(d.y,d.m-1,d.d));
      return iso(dt);
    }
  }
  const str=String(v).trim();
  if(!str) return "";
  const dt=new Date(str);
  return isNaN(dt.getTime())?str:iso(dt);
}

function normalizeSupplierRow(row){
  const obj={};
  let hasData=false;
  for(const col of SUPPLIER_COLUMNS){
    const raw=row?.[col.header] ?? row?.[col.header.trim()] ?? row?.[col.header.replace(/\s+/g," ")] ?? "";
    let val=raw;
    if(col.type==="date"){
      val=normalizeExcelDate(raw);
    }else if(col.type==="currency"||col.type==="number"||col.type==="percent"){
      const str=String(raw??"").trim();
      if(str){
        const n=num(str);
        val=Number.isFinite(n)?n:str;
      }else val="";
    }else{
      val=String(raw??"").trim();
    }
    if(val!=="" && val!=null) hasData=true;
    obj[col.key]=val;
  }
  return hasData?obj:null;
}

function fixMojibake(str){
  if(typeof str!=="string"||!str) return str;
  if(!/[√É√Ç√ä√é√î√£√µ√±√°√©√≠√≥√∫√Å√â√ç√ì√ö√†√®√¨√≤√π√§√´√Ø√∂√º√Ñ√ã√è√ñ√ú]/.test(str)) return str;
  if(typeof escape!=="function"||typeof decodeURIComponent!=="function") return str;
  try{
    return decodeURIComponent(escape(str));
  }catch(err){
    return str;
  }
}

function normalizeBankHeader(key){
  if(!key) return "";
  const fixed=fixMojibake(String(key).trim());
  return fixed
    .normalize("NFD").replace(/[\u0300-\u036f]/g,"")
    .toLowerCase()
    .replace(/[^a-z0-9]+/g,"_")
    .replace(/^_|_$/g,"");
}

function resolveBankHeaderKey(key){
  const norm=normalizeBankHeader(key);
  if(!norm) return {normalized:"",mapped:""};
  if(BANK_HEADER_MAP[norm]){
    return {normalized:norm,mapped:BANK_HEADER_MAP[norm]};
  }
  const canonical=BANK_HEADER_REVERSE[norm];
  if(canonical){
    return {normalized:canonical,mapped:BANK_HEADER_MAP[canonical]};
  }
  return {normalized:norm,mapped:norm};
}

function parseMaybeNumber(val){
  if(val==null || val==="") return null;
  if(typeof val==="number") return Number.isFinite(val)?val:null;
  const str=String(val).trim();
  if(!str) return null;
  const parsed=num(str);
  return Number.isFinite(parsed)?parsed:null;
}

function normalizeMatchText(str){
  if(str==null) return "";
  return fixMojibake(String(str))
    .normalize("NFD").replace(/[\u0300-\u036f]/g,"")
    .toLowerCase();
}

function normalizeMatchKey(str){
  return normalizeMatchText(str).replace(/[^a-z0-9]/g,"");
}

function bankPrimaryDate(row){
  if(!row) return "";
  return row.value_date || row.execution_date || row.date || "";
}

function bankSortValue(row,key){
  if(!row) return "";
  if(key==="value_date"||key==="execution_date"||key==="date"){
    return bankPrimaryDate(row);
  }
  if(key==="amount"){
    const val=typeof row.amount==="number"?row.amount:num(row.amount);
    return Number.isFinite(val)?val:0;
  }
  if(key==="balance"){
    if(typeof row.balance==="number" && Number.isFinite(row.balance)) return row.balance;
    const val=num(row.balance_display||0);
    return Number.isFinite(val)?val:0;
  }
  return row[key]??"";
}

function formatBankMoney(value, display){
  if(display!=null && String(display).trim()!="") return display;
  if(value==null || value==="") return "";
  const n=typeof value==="number"?value:num(value);
  return Number.isFinite(n)?fmt.format(n):"";
}

function normalizeBankRow(row){
  const mapped={};
  let hasData=false;
  for(const [key,val] of Object.entries(row||{})){
    if(key==null) continue;
    const {normalized,mapped:mappedKey}=resolveBankHeaderKey(key);
    if(!normalized||!mappedKey) continue;
    mapped[mappedKey]=typeof val==="string"?fixMojibake(val):val;
    if(val!=null){
      if(typeof val==="number" && !Number.isNaN(val)) hasData=true;
      else if(String(val).trim()!="") hasData=true;
    }
  }
  if(!hasData) return null;
  const executionDate=normalizeExcelDate(mapped.execution_date||"");
  const valueDate=normalizeExcelDate(mapped.value_date||"");
  const date=valueDate||executionDate||"";
  const concept=fixMojibake(String(mapped.concept??"")).trim();
  const details=fixMojibake(String(mapped.details??"")).trim();
  const description=[concept,details].filter(Boolean).join(" ‚Äî ") || concept || details || "";
  const invoice=fixMojibake(String(mapped.invoice??mapped.invoice_no??"")).trim();
  const amountRaw=mapped.amount;
  const balanceRaw=mapped.balance;
  const amountVal=parseMaybeNumber(amountRaw);
  const balanceVal=parseMaybeNumber(balanceRaw);
  const amount=Number.isFinite(amountVal)?amountVal:0;
  const amountDisplay=!Number.isFinite(amountVal)&&amountRaw!=null&&String(amountRaw).trim()!==""?String(amountRaw):"";
  const balance=Number.isFinite(balanceVal)?balanceVal:null;
  const balanceDisplay=!Number.isFinite(balanceVal)&&balanceRaw!=null&&String(balanceRaw).trim()!==""?String(balanceRaw):"";
  const type=amount>=0?"credit":"debit";
  return {
    date,
    description,
    amount,
    amount_display:amountDisplay,
    type,
    invoice_no:invoice,
    match_status:"unmatched",
    execution_date:executionDate,
    value_date:valueDate,
    balance,
    balance_display:balanceDisplay,
    concept,
    details,
    _source:BANK_IMPORT_SOURCE
  };
}

function supplierCellText(col,val){
  if(val==null||val==="") return "";
  if(col.type==="currency"){
    const n=typeof val==="number"?val:num(val);
    return Number.isFinite(n)?fmt.format(n):String(val);
  }
  if(col.type==="percent"){
    const n=typeof val==="number"?val:num(val);
    if(!Number.isFinite(n)) return String(val);
    const pct=n>1?n:(n*100);
    return `${pct.toFixed(2)}%`;
  }
  if(col.type==="number"){
    const n=typeof val==="number"?val:num(val);
    return Number.isFinite(n)?String(n):String(val);
  }
  return String(val);
}

function buildSupplierHeader(){
  const head=$("#supHead");
  if(head && !head.dataset.ready){
    head.innerHTML=SUPPLIER_COLUMNS.map(col=>`<th>${col.header}</th>`).join("");
    head.dataset.ready="1";
  }
}

function renderSuppliersTable(){
  buildSupplierHeader();
  const tb=$("#supTbl tbody");
  if(!tb) return;
  if(!State.suppliers.length){
    tb.innerHTML=`<tr><td colspan="${SUPPLIER_COLUMNS.length}" class="tiny">No supplier invoices imported yet.</td></tr>`;
  }else{
    tb.innerHTML=State.suppliers.map(row=>`<tr>${SUPPLIER_COLUMNS.map(col=>`<td${col.type!=="text"?" class=\"mono\"":""}>${supplierCellText(col,row[col.key])}</td>`).join("")}</tr>`).join("");
  }
  const cnt=$("#supCount"); if(cnt) cnt.textContent=State.suppliers.length;
}

function applySupplierRows(rows){
  const normalized=rows.map(normalizeSupplierRow).filter(Boolean);
  State.suppliers=normalized;
  syncPurchFromSuppliers();
  refreshAll();
  $("#env").textContent="Supplier invoices imported (unsaved)";
}

function applyBankImportRows(rows, headers=[]){
  const headerSet=new Set();
  if(Array.isArray(headers) && headers.length){
    for(const header of headers){
      const {normalized}=resolveBankHeaderKey(header);
      if(normalized) headerSet.add(normalized);
    }
  }else if(Array.isArray(rows) && rows.length){
    for(const row of rows){
      for(const key of Object.keys(row||{})){
        const {normalized}=resolveBankHeaderKey(key);
        if(normalized) headerSet.add(normalized);
      }
      if(headerSet.size) break;
    }
  }
  if((rows?.length||0) || headerSet.size){
    if(headerSet.size===0 && rows?.length){
      throw new Error("Unable to detect bank column headers. Ensure the first row contains the expected titles.");
    }
    const missing=BANK_REQUIRED_HEADERS.filter(req=>!headerSet.has(req));
    if(missing.length){
      const friendly=missing.map(key=>BANK_HEADER_LABELS[key]||key);
      throw new Error(`Missing required columns: ${friendly.join(", ")}`);
    }
  }
  const normalized=(rows||[]).map(normalizeBankRow).filter(Boolean);
  const manual=State.bank.filter(b=>b._source!==BANK_IMPORT_SOURCE);
  State.bank=[...manual,...normalized];
  State.sel.bank=null;
  refreshAll();
  $("#env").textContent = normalized.length
    ? `Bank transactions imported (${normalized.length}) (unsaved)`
    : "Bank import contained no rows; existing imported entries cleared";
}

function updateBankImportSummary(){
  const cnt=$("#bankCount");
  if(!cnt) return;
  const imported=State.bank.filter(b=>b._source===BANK_IMPORT_SOURCE).length;
  cnt.textContent=imported;
}

function parseCSVLine(line){
  const res=[]; let field=""; let inQuotes=false;
  for(let i=0;i<line.length;i++){
    const ch=line[i];
    if(ch==='"'){
      if(inQuotes && line[i+1]==='"'){ field+='"'; i++; }
      else inQuotes=!inQuotes;
    }else if(ch===',' && !inQuotes){ res.push(field); field=""; }
    else field+=ch;
  }
  res.push(field);
  return res.map(c=>c.trim());
}

function parseCSVTable(text){
  const sanitized=String(text??"").replace(/^\uFEFF/,"");
  const lines=sanitized.split(/\r?\n/).filter((line,i,arr)=>!(i===arr.length-1 && line.trim()===""));
  while(lines.length && !lines[0].trim()) lines.shift();
  if(!lines.length) return {headers:[],rows:[]};
  const headers=parseCSVLine(lines[0]);
  const rows=[];
  for(let i=1;i<lines.length;i++){
    const line=lines[i];
    if(!line.trim()) continue;
    const cells=parseCSVLine(line);
    if(cells.every(cell=>cell==="")) continue;
    const row={};
    headers.forEach((h,idx)=>{
      if(!h) return;
      row[h]=cells[idx]??"";
    });
    rows.push(row);
  }
  return {headers,rows};
}

function safeSheetCellValue(cell){
  if(!cell) return {value:"",hasContent:false};
  let value;
  try{
    value=cell.v;
  }catch(err){
    if(typeof console!=="undefined" && typeof console.warn==="function"){
      console.warn("Failed to read raw cell value", err);
    }
  }
  if((value==null || value==="") && cell){
    try{
      const formatted=cell.w;
      if(formatted!=null && formatted!=="") value=formatted;
    }catch(err){
      if(typeof console!=="undefined" && typeof console.warn==="function"){
        console.warn("Failed to read formatted cell value", err);
      }
    }
  }
  if(typeof value==="string") value=value.trim();
  if(value==null || value==="" || (typeof value==="number" && Number.isNaN(value))){
    return {value:"",hasContent:false};
  }
  return {value,hasContent:true};
}

function sheetToTable(sheet){
  const utils=window.XLSX?.utils;
  if(!sheet||!utils||!sheet["!ref"]) return {headers:[],rows:[]};
  const range=utils.decode_range(sheet["!ref"]);
  let headerRow=-1;
  let headerValues=[];
  for(let r=range.s.r;r<=range.e.r;r++){
    const current=[];
    let nonEmpty=false;
    for(let c=range.s.c;c<=range.e.c;c++){
      const cell=sheet[utils.encode_cell({r,c})];
      const {value,hasContent}=safeSheetCellValue(cell);
      if(hasContent) nonEmpty=true;
      current.push(value);
    }
    if(nonEmpty){
      headerRow=r;
      headerValues=current.map(v=>{
        if(v==null) return "";
        const str=typeof v==="string"?v:String(v);
        return str.trim();
      });
      break;
    }
  }
  if(headerRow<0) return {headers:[],rows:[]};
  const cleanHeaders=headerValues.map(v=>String(v??"").trim());
  const rows=[];
  for(let r=headerRow+1;r<=range.e.r;r++){
    const row={};
    let hasData=false;
    for(let c=range.s.c;c<=range.e.c;c++){
      const header=cleanHeaders[c-range.s.c];
      if(!header) continue;
      const cell=sheet[utils.encode_cell({r,c})];
      const {value,hasContent}=safeSheetCellValue(cell);
      if(hasContent) hasData=true;
      row[header]=value;
    }
    if(hasData) rows.push(row);
  }
  const finalHeaders=cleanHeaders.filter(Boolean);
  return {headers:finalHeaders,rows};
}

async function importSupplierExcel(file){
  const name=file.name.toLowerCase();
  if(name.endsWith(".csv")){
    const fr=new FileReader();
    fr.onload=()=>{
      const text=String(fr.result||"").replace(/^\uFEFF/,"");
      const lines=text.split(/\r?\n/).filter((l,i,arr)=>!(i===arr.length-1 && l.trim()===""));
      if(!lines.length) return applySupplierRows([]);
      const headers=parseCSVLine(lines[0]);
      const rows=[];
      for(let i=1;i<lines.length;i++){
        const line=lines[i];
        if(!line.trim()) continue;
        const cells=parseCSVLine(line);
        const row={};
        headers.forEach((h,idx)=>{ row[h]=cells[idx]??""; });
        rows.push(row);
      }
      applySupplierRows(rows);
    };
    fr.readAsText(file);
  }else{
    try{
      await ensureXLSX();
    }catch(err){
      console.error(err);
      alert("Failed to load Excel parser: "+err.message);
      return;
    }
    const fr=new FileReader();
    fr.onload=()=>{
      try{
        const data=new Uint8Array(fr.result);
        const wb=XLSX.read(data,{type:"array",cellDates:true});
        const sheet=wb.Sheets[wb.SheetNames[0]];
        if(!sheet){ alert("No sheets found in workbook"); return; }
        const {rows}=sheetToTable(sheet);
        applySupplierRows(rows);
      }catch(err){
        console.error(err);
        alert("Failed to parse Excel file: "+err.message);
      }
    };
    fr.readAsArrayBuffer(file);
  }
}

async function importBankExcel(file){
  const name=file.name.toLowerCase();
  if(name.endsWith(".csv")){
    const fr=new FileReader();
    fr.onload=()=>{
      try{
        const {headers,rows}=parseCSVTable(fr.result);
        applyBankImportRows(rows, headers);
      }catch(err){
        console.error(err);
        alert("Failed to parse CSV file: "+err.message);
      }
    };
    fr.readAsText(file);
  }else{
    try{
      await ensureXLSX();
    }catch(err){
      console.error(err);
      alert("Failed to load Excel parser: "+err.message);
      return;
    }
    const fr=new FileReader();
    fr.onload=()=>{
      try{
        const data=new Uint8Array(fr.result);
        const wb=XLSX.read(data,{type:"array",cellDates:true});
        const sheet=wb.Sheets[wb.SheetNames[0]];
        if(!sheet){ alert("No sheets found in workbook"); return; }
        const {headers,rows}=sheetToTable(sheet);
        applyBankImportRows(rows, headers);
      }catch(err){
        console.error(err);
        alert("Failed to parse Excel file: "+err.message);
      }
    };
    fr.readAsArrayBuffer(file);
  }
}

function downloadSupplierTemplate(){
  const head=SUPPLIER_COLUMNS.map(col=>`"${col.header}"`).join(",");
  download("supplier_invoices_template.csv", head+"\n", "text/csv");
}

/* ===== Filters ===== */
const filtered = {
  sales:()=> State.sales.filter(r=>{
    const f=State.filter.sales, q=(f.q||"").toLowerCase();
    const inR=(!f.from||r.date>=f.from)&&(!f.to||r.date<=f.to);
    const st = !f.st||r.status===f.st;
    const qok = !q||[r.invoice_no,r.customer,r.notes].join(" ").toLowerCase().includes(q);
    return inR&&st&&qok;
  }).sort(by(State.sort.sales.k, State.sort.sales.d)),
  purch:()=> State.purch.filter(r=>{
    const f=State.filter.purch,q=(f.q||"").toLowerCase();
    const inR=(!f.from||r.date>=f.from)&&(!f.to||r.date<=f.to);
    const estado=String(r.estado_pago??"").trim().toUpperCase();
    const stOk=!f.st||(
      f.st==="paid"?estado==="PAGADA":
      f.st==="partial"?estado.includes("PARC"):
      f.st==="unpaid"?(estado===""||(!estado.includes("PARC")&&estado!=="PAGADA"))
      :true
    );
    const haystack=PURCHASE_COLUMNS.map(col=>r[col.key]).concat([r.notes,r.pdf_link])
      .map(v=>v??"").join(" ");
    const qok=!q||haystack.toLowerCase().includes(q);
    return inR&&stOk&&qok;
  }).sort(by(State.sort.purch.k, State.sort.purch.d)),
  bank:()=>{
    const f=State.filter.bank;
    const q=normalizeMatchText(f.q||"");
    const rows=State.bank.filter(r=>{
      const rowDate=bankPrimaryDate(r);
      const inR=(!f.from||rowDate>=f.from)&&(!f.to||rowDate<=f.to);
      const ty=!f.type||r.type===f.type;
      if(!inR||!ty) return false;
      if(!q) return true;
      const haystack=[
        r.concept,r.details,r.invoice_no,r.description,r.amount_display,r.balance_display,
        bankPrimaryDate(r), fmt.format(num(r.amount)),
        r.balance!=null?fmt.format(num(r.balance)):"", r.type
      ].map(normalizeMatchText).join(" ");
      return haystack.includes(q);
    });
    const {k,d}=State.sort.bank;
    return rows.sort((a,b)=>{
      const av=bankSortValue(a,k);
      const bv=bankSortValue(b,k);
      if(av===bv) return 0;
      return av>bv?d:-d;
    });
  }
};

/* ===== CRUD Modal ===== */
let modalCtx=null; // {type:'sales'|'purch'|'bank', mode:'add'|'edit', rec:{}}
const FIELDS = {
  sales:[
    ["invoice_no","Invoice #","text"],["date","Date","date"],["customer","Customer","text"],["amount","Amount","number"],
    ["status","Status","select","paid,unpaid,partial"],["paid_date","Paid Date","date"],["pdf_link","PDF link","text"],["notes","Notes","textarea"]
  ],
  purch:[
    ["invoice_no","Invoice #","text"],["date","Date","date"],["supplier","Supplier","text"],["amount","Amount","number"],
    ["status","Status","select","conciliado,no conciliado"],["paid_date","Paid Date","date"],["due_date","Due Date","date"],
    ["forma_pago","Payment Method","text"],["departamento","Department","text"],["categoria","Category","text"],
    ["retention_amount","Retention Amount","number"],["retention_rate","Retention Rate (%)","number"],
    ["codigo_er","ERP Code","text"],["opex_capex","OPEX/CAPEX","text"],["payment_auth","Payment Authorization","text"],
    ["pdf_link","PDF link","text"]
  ],
  bank:[
    ["execution_date","F. ejecuci√≥n","date"],["value_date","F. valor","date"],["concept","Concepto","text"],
    ["details","Desglose","textarea"],["amount","Importe","number"],["balance","Saldo","number"],
    ["invoice_no","FACTURA","text"],["match_status","Match","select","matched,unmatched,partial,unknown"]
  ]
};

const SUPPLIER_COLUMNS = [
  {header:"Sociedad",key:"sociedad",type:"text"},
  {header:"Periodo Contable",key:"periodo_contable",type:"text"},
  {header:"Fecha factura",key:"fecha_factura",type:"date"},
  {header:"Raz√≥n Social",key:"razon_social",type:"text"},
  {header:"VAT Number",key:"vat_number",type:"text"},
  {header:"C.P.",key:"cp",type:"text"},
  {header:"N√∫mero factura",key:"numero_factura",type:"text"},
  {header:"DC",key:"dc",type:"text"},
  {header:"Base imponible",key:"base_imponible",type:"currency"},
  {header:"Tipo general",key:"tipo_general",type:"text"},
  {header:"Tipo secundario",key:"tipo_secundario",type:"text"},
  {header:"Tipo secundario 2",key:"tipo_secundario_2",type:"text"},
  {header:"Tipo secundario 3",key:"tipo_secundario_3",type:"text"},
  {header:"Cuota sin IVA",key:"cuota_sin_iva",type:"currency"},
  {header:"Tipo de Operaci√≥n",key:"tipo_operacion",type:"text"},
  {header:"Importe Retenci√≥n",key:"importe_retencion",type:"currency"},
  {header:"Porcentaje Retenci√≥n",key:"porcentaje_retencion",type:"percent"},
  {header:"Importe Total",key:"importe_total",type:"currency"},
  {header:"OPEX/CAPEX",key:"opex_capex",type:"text"},
  {header:"Departamento",key:"departamento",type:"text"},
  {header:"Categor√≠a",key:"categoria",type:"text"},
  {header:"C√≥digo ER",key:"codigo_er",type:"text"},
  {header:"Cuenta contable",key:"cuenta_contable",type:"text"},
  {header:"Nombre de la Cuenta pa√≠s",key:"nombre_cuenta_pais",type:"text"},
  {header:"Cuenta consolidada",key:"cuenta_consolidada",type:"text"},
  {header:"Nombre consolidado",key:"nombre_consolidado",type:"text"},
  {header:"Concepto libre",key:"concepto_libre",type:"text"},
  {header:"CUPS",key:"cups",type:"text"},
  {header:"Autorizaci√≥n Pago",key:"autorizacion_pago",type:"text"},
  {header:"Fecha Vencimiento",key:"fecha_vencimiento",type:"date"},
  {header:"Fecha tope pago",key:"fecha_tope_pago",type:"date"},
  {header:"Fecha actual",key:"fecha_actual",type:"date"},
  {header:"D√≠as de Margen",key:"dias_margen",type:"number"},
  {header:"Estado del Pago",key:"estado_pago",type:"text"},
  {header:"Forma de Pago",key:"forma_pago",type:"text"},
  {header:"Fecha de Pago",key:"fecha_pago",type:"date"},
  {header:"PMP",key:"pmp",type:"number"}
];

const PURCHASE_COLUMNS = (()=>{
  const base=[
    {header:"Invoice #",key:"invoice_no",type:"text"},
    {header:"Date",key:"date",type:"date"},
    {header:"Supplier",key:"supplier",type:"text"},
    {header:"Status",key:"status",type:"status"},
    {header:"Paid Date",key:"paid_date",type:"date"},
    {header:"Supplier Payment Status",key:"supplier_payment_status",type:"status"},
    {header:"Supplier Paid Date",key:"supplier_paid_date",type:"date"},
    {header:"Due Date",key:"due_date",type:"date"},
    {header:"Payment Deadline",key:"payment_deadline",type:"date"},
    {header:"Amount",key:"amount",type:"currency"},
    {header:"Base Amount",key:"base_amount",type:"currency"},
    {header:"Retention Amount",key:"retention_amount",type:"currency"},
    {header:"Retention Rate",key:"retention_rate",type:"percent"},
    {header:"Payment Authorization",key:"payment_auth",type:"text"},
    {header:"PDF",key:"pdf_link",type:"link"}
  ];
  const seen=new Set(base.map(col=>col.key));
  SUPPLIER_COLUMNS.forEach(col=>{
    if(!seen.has(col.key)){
      base.push({header:col.header,key:col.key,type:col.type});
      seen.add(col.key);
    }
  });
  return base;
})();

function visiblePurchaseColumns(){
  return PURCHASE_COLUMNS.filter(col=>!State.hidden.purch.has(col.key));
}

function loadPurchHiddenColumns(){
  try{
    const stored=JSON.parse(localStorage.getItem(PURCH_COL_PREF_KEY)||"[]");
    if(Array.isArray(stored)){
      State.hidden.purch=new Set(stored.filter(key=>PURCHASE_COLUMNS.some(col=>col.key===key)));
    }else{
      State.hidden.purch=new Set();
    }
  }catch(err){
    console.warn("Failed to load purchase column prefs", err);
    State.hidden.purch=new Set();
  }
}

function savePurchHiddenColumns(){
  try{
    localStorage.setItem(PURCH_COL_PREF_KEY, JSON.stringify([...State.hidden.purch]));
  }catch(err){
    console.warn("Failed to save purchase column prefs", err);
  }
}

function renderPurchaseColumnMenu(){
  const list=$("#pColList");
  if(!list) return;
  const visibleKeys=visiblePurchaseColumns().map(col=>col.key);
  list.innerHTML=PURCHASE_COLUMNS.map(col=>{
    const checked=!State.hidden.purch.has(col.key);
    const disabled=checked && visibleKeys.length===1 && visibleKeys[0]===col.key;
    return `<label><input type="checkbox" data-key="${col.key}"${checked?" checked":""}${disabled?" disabled":""}>${col.header}</label>`;
  }).join("");
}

function formatPurchaseCell(col,row){
  const val=row?.[col.key];
  if(col.type==="link") return val?`<a href="${val}" target="_blank">Open</a>`:"‚Äî";
  if(col.type==="status"){
    if(!val) return "‚Äî";
    const norm=String(val).trim().toLowerCase();
    let cls="warn";
    if(["conciliado","paid","pagada"].includes(norm)) cls="ok";
    else if(norm.includes("parc")) cls="warn";
    else if(["no conciliado","unpaid","pendiente","impagada","no pagada","no pagado"].includes(norm)) cls="bad";
    return `<span class="status ${cls}">${val}</span>`;
  }
  if(val==null||val==="") return "‚Äî";
  if(col.type==="currency"){
    const n=typeof val==="number"?val:num(val);
    return Number.isFinite(n)?fmt.format(n):String(val);
  }
  if(col.type==="percent"){
    const n=typeof val==="number"?val:num(val);
    if(!Number.isFinite(n)) return String(val);
    const pct=n>1?n:(n*100);
    return `${pct.toFixed(2)}%`;
  }
  if(col.type==="number"){
    const n=typeof val==="number"?val:num(val);
    return Number.isFinite(n)?String(n):String(val);
  }
  return String(val);
}

function purchaseCSVValue(col,row){
  const val=row?.[col.key];
  if(val==null||val==="") return "";
  if(col.type==="currency"||col.type==="number"||col.type==="percent"){
    const n=typeof val==="number"?val:num(val);
    return Number.isFinite(n)?n:val;
  }
  if(col.type==="link"||col.type==="status") return val;
  return val;
}

function mapSupplierToPurchase(row, prev){
  const amountTotal=num(row.importe_total);
  const baseAmount=num(row.base_imponible);
  const retentionAmount=num(row.importe_retencion);
  const invoiceNo=row.numero_factura||row.dc||"";
  const key=invKey(invoiceNo);
  let reconciled=false;
  let reconciliationDate="";
  if(key){
    for(const b of State.bank){
      if(invKey(b.invoice_no)===key){
        const ms=(b.match_status||"").toLowerCase();
        if(ms==="matched"){
          reconciled=true;
          reconciliationDate=b.date||reconciliationDate;
          break;
        }
      }
    }
  }
  const estadoPagoRaw=String(row.estado_pago??"").trim();
  const status=reconciled?"conciliado":"no conciliado";
  let paidDate=row.fecha_pago||"";
  const manualPaidDate=(prev && prev._source!=="supplier" && prev.paid_date)?prev.paid_date:"";
  if(reconciled){
    paidDate=manualPaidDate||reconciliationDate||paidDate;
  }else if(manualPaidDate){
    paidDate=manualPaidDate;
  }
  const purchase={
    invoice_no:invoiceNo,
    date:row.fecha_factura||"",
    supplier:row.razon_social||row.sociedad||"",
    amount:Number.isFinite(amountTotal)?amountTotal:Number.isFinite(baseAmount)?baseAmount:0,
    status,
    supplier_payment_status:estadoPagoRaw,
    paid_date:paidDate,
    supplier_paid_date:row.fecha_pago||"",
    due_date:row.fecha_vencimiento||row.fecha_tope_pago||"",
    payment_deadline:row.fecha_tope_pago||"",
    retention_amount:Number.isFinite(retentionAmount)?retentionAmount:0,
    retention_rate:row.porcentaje_retencion??"",
    opex_capex:row.opex_capex||"",
    departamento:row.departamento||"",
    categoria:row.categoria||"",
    codigo_er:row.codigo_er||"",
    forma_pago:row.forma_pago||"",
    payment_auth:row.autorizacion_pago||"",
    periodo_contable:row.periodo_contable||"",
    vat_number:row.vat_number||"",
    sociedad:row.sociedad||"",
    base_amount:Number.isFinite(baseAmount)?baseAmount:0,
    dias_margen:row.dias_margen??"",
    concepto_libre:row.concepto_libre||"",
    supplier_details:row,
    _source:"supplier"
  };
  for(const col of SUPPLIER_COLUMNS){
    if(!(col.key in purchase)) purchase[col.key]=row[col.key]??"";
  }
  if(!Number.isFinite(purchase.amount)) purchase.amount=0;
  return purchase;
}

function syncPurchFromSuppliers(){
  const existingByInv=new Map();
  State.purch.forEach(p=>{
    const key=invKey(p.invoice_no);
    if(key) existingByInv.set(key,p);
  });
  const supNos=new Set(State.suppliers.map(r=>invKey(r.numero_factura||r.dc)));
  const manual=State.purch.filter(p=>{
    if(p._source==="supplier") return false;
    const inv=invKey(p.invoice_no);
    return !supNos.has(inv);
  });
  const imported=State.suppliers.map(row=>{
    const key=invKey(row.numero_factura||row.dc);
    const prev=key?existingByInv.get(key):null;
    const purchase=mapSupplierToPurchase(row, prev);
    if(prev){
      ["pdf_link","notes","payment_auth"].forEach(field=>{
        if(prev[field] && !purchase[field]) purchase[field]=prev[field];
      });
      if(prev._source!=="supplier" && !purchase.notes && prev.notes) purchase.notes=prev.notes;
    }
    return purchase;
  });
  State.purch=[...manual,...imported];
  State.sel.purch=null;
}
function openModal(type, mode, rec){
  modalCtx={type,mode,rec: Object.assign({},rec||{})};
  $("#mTitle").textContent= (mode==="add"?"Add ":"Edit ")+type;
  const form=$("#mForm"); form.innerHTML="";
  for(const [k,lab,t,opt] of FIELDS[type]){
    const id="f_"+k; const val=modalCtx.rec[k]??"";
    form.insertAdjacentHTML("beforeend",`<div><label for="${id}">${lab}</label>${
      t==="select"? `<select id="${id}">${opt.split(",").map(o=>`<option ${String(val)===o?'selected':''}>${o}</option>`).join("")}</select>`:
      t==="textarea"? `<textarea id="${id}" rows="2">${val??""}</textarea>`:
      `<input id="${id}" type="${t}" value="${t==="number"?String(val):String(val)}">`
    }</div>`);
  }
  $("#modal").classList.add("open");
}
$("#mCancel").onclick=()=> $("#modal").classList.remove("open");
$("#mSave").onclick=()=>{
  const obj={};
  for(const [k,_,t] of FIELDS[modalCtx.type]){
    const v=$("#f_"+k).value;
    obj[k]= (t==="number")? num(v) : v;
  }
  if(modalCtx.type==="bank"){
    const amountInput=$("#f_amount").value;
    const balanceInput=$("#f_balance").value;
    obj.amount = amountInput===""?0:num(amountInput);
    obj.amount_display="";
    obj.balance = balanceInput===""?null:obj.balance;
    obj.balance_display="";
    obj.type = obj.amount>=0?"credit":"debit";
    obj.match_status = obj.match_status||"unmatched";
    obj.date = bankPrimaryDate(obj);
    obj.description=[obj.concept,obj.details].filter(Boolean).join(" ‚Äî ");
  }else{
    obj.amount=num(obj.amount);
  }
  const key=modalCtx.type==="sales"?"sales":modalCtx.type==="purch"?"purch":"bank";
  const col=State[key];
  if(modalCtx.mode==="add"){
    col.push(obj);
  }else{
    const existing=State.sel[key];
    const idx=col.indexOf(existing);
    if(idx>-1){
      const merged=Object.assign({}, existing||{}, obj);
      if(existing && existing._source==="supplier"){
        merged._source="supplier";
        merged.supplier_details=existing.supplier_details;
      }
      col[idx]=merged;
      State.sel[key]=merged;
    }
  }
  $("#modal").classList.remove("open");
  refreshAll(); $("#env").textContent="Edited (unsaved)";
};

/* ===== Rendering ===== */
function renderAll(){ renderKPIs(); renderAging(); render.sales(); render.purch(); render.bank(); render.suppliers(); renderAudit(); }

function renderKPIs(){
  const ym=new Date().toISOString().slice(0,7);
  const sMonth=State.sales.filter(s=>(s.date||"").startsWith(ym));
  $("#kpiSalesCnt").textContent=sMonth.length;
  $("#kpiSalesSum").textContent=fmt.format(sMonth.reduce((a,b)=>a+num(b.amount),0));
  const unpaid=State.sales.filter(s=>["unpaid","partial"].includes(s.status));
  $("#kpiUnpaidCnt").textContent=unpaid.length;
  $("#kpiUnpaidSum").textContent=fmt.format(unpaid.reduce((a,b)=>a+num(b.amount),0));
  const pMonth=State.purch.filter(p=>(p.date||"").startsWith(ym));
  $("#kpiPurchCnt").textContent=pMonth.length;
  $("#kpiPurchSum").textContent=fmt.format(pMonth.reduce((a,b)=>a+num(b.amount),0));
  const open=State.bank.filter(b=>b.match_status!=="matched");
  $("#kpiBankOpen").textContent=open.length;
  $("#kpiBankSum").textContent=fmt.format(open.reduce((a,b)=>a+Math.abs(num(b.amount)),0));
  // quick checks
  const dups=dupDetect(State.sales.map(x=>x.invoice_no).filter(Boolean));
  $("#qcDup").textContent=`Duplicates: ${dups.length}`;
  const gaps=numGaps(State.sales.map(x=>x.invoice_no));
  $("#qcGap").textContent=`Numbering gaps: ${gaps.length}`;
  const orph=State.sales.filter(s=>!State.bank.some(b=>b.invoice_no===s.invoice_no)&&s.status!=="paid").length;
  $("#qcOrph").textContent=`Orphans (no bank): ${orph}`;
}

function renderAging(){
  // Aging by customer on unpaid/partial; assume due in 30 days from invoice date
  const buckets={}; // {customer:{c0:0,c30:0,c60:0,c90:0,c91:0}}
  const now=new Date();
  for(const s of State.sales){
    if(s.status==="paid") continue;
    const days=Math.floor((now - new Date(s.date))/(1000*3600*24));
    const c=s.customer||"‚Äî";
    buckets[c]=buckets[c]||{c0:0,c30:0,c60:0,c90:0,c91:0};
    if(days<=0) buckets[c].c0+=num(s.amount);
    else if(days<=30) buckets[c].c30+=num(s.amount);
    else if(days<=60) buckets[c].c60+=num(s.amount);
    else if(days<=90) buckets[c].c90+=num(s.amount);
    else buckets[c].c91+=num(s.amount);
  }
  const tb=$("#aging tbody"); tb.innerHTML="";
  Object.entries(buckets).forEach(([cust,b])=>{
    const tot=b.c0+b.c30+b.c60+b.c90+b.c91;
    tb.insertAdjacentHTML("beforeend",`<tr>
      <td>${cust}</td>
      <td class="mono">${fmt.format(b.c0)}</td>
      <td class="mono">${fmt.format(b.c30)}</td>
      <td class="mono">${fmt.format(b.c60)}</td>
      <td class="mono">${fmt.format(b.c90)}</td>
      <td class="mono">${fmt.format(b.c91)}</td>
      <td class="mono"><b>${fmt.format(tot)}</b></td>
    </tr>`);
  });
}

const render = {
  sales(){
    const rows=filtered.sales(); const tb=$("#sTbl tbody"); tb.innerHTML="";
    rows.forEach((r,i)=>tb.insertAdjacentHTML("beforeend", `<tr data-i="${i}">
      <td>${r.invoice_no||""}</td><td>${r.date||""}</td><td>${r.customer||""}</td>
      <td class="mono">${fmt.format(num(r.amount))}</td>
      <td><span class="status ${r.status==="paid"?"ok":r.status==="unpaid"?"bad":"warn"}">${r.status||"‚Äî"}</span></td>
      <td>${r.paid_date||"‚Äî"}</td>
      <td>${r.pdf_link?`<a href="${r.pdf_link}" target="_blank">Open</a>`:"‚Äî"}</td>
      <td>${r.notes||""}</td>
    </tr>`));
    selectRow(tb,"sales");
  },
  purch(){
    let cols=visiblePurchaseColumns();
    if(!cols.length){
      State.hidden.purch.clear();
      savePurchHiddenColumns();
      cols=visiblePurchaseColumns();
    }
    renderPurchaseColumnMenu();
    const head=$("#pHead");
    if(head){
      head.innerHTML=cols.map(col=>`<th data-k="${col.key}"${["currency","number","percent"].includes(col.type)?" class=\"mono\"":""}>${col.header}</th>`).join("");
    }
    const rows=filtered.purch(); const tb=$("#pTbl tbody"); tb.innerHTML="";
    rows.forEach((r,i)=>{
      const cells=cols.map(col=>{
        const cls=["currency","number","percent"].includes(col.type)?" class=\"mono\"":"";
        return `<td${cls}>${formatPurchaseCell(col,r)}</td>`;
      }).join("");
      tb.insertAdjacentHTML("beforeend", `<tr data-i="${i}">${cells}</tr>`);
    });
    selectRow(tb,"purch");
  },
  bank(){
    const rows=filtered.bank(); const tb=$("#bTbl tbody"); tb.innerHTML="";
    rows.forEach((r,i)=>tb.insertAdjacentHTML("beforeend", `<tr data-i="${i}">
      <td>${r.execution_date||r.date||""}</td>
      <td>${r.value_date||""}</td>
      <td>${r.concept||""}</td>
      <td class="mono">${formatBankMoney(r.amount, r.amount_display)}</td>
      <td class="mono">${formatBankMoney(r.balance, r.balance_display)}</td>
      <td>${r.invoice_no||""}</td>
      <td>${r.details||""}</td>
      <td><span class="status ${r.match_status==="matched"?"ok":r.match_status==="unmatched"?"bad":"warn"}">${r.match_status||"unknown"}</span></td>
    </tr>`));
    selectRow(tb,"bank");
    $("#bStats").textContent=`${rows.length} tx ‚Ä¢ ${fmt.format(rows.reduce((a,b)=>a+num(b.amount),0))}`;
    $("#bOpen").textContent=`Open: ${rows.filter(x=>x.match_status!=="matched").length}`;
    updateBankImportSummary();
  },
  suppliers: renderSuppliersTable
};

/* ===== Audit ===== */
function dupDetect(list){ const s=new Set(),d=new Set(); for(const v of list){ if(s.has(v)) d.add(v); else s.add(v);} return [...d]; }
function numGaps(ids){
  const arr=ids.map(x=>{ const m=String(x).match(/(\d+)$/); return m?+m[1]:null;}).filter(x=>x!=null).sort((a,b)=>a-b);
  const gaps=[]; for(let i=1;i<arr.length;i++){ const diff=arr[i]-arr[i-1]; if(diff>1) gaps.push([arr[i-1],arr[i]]); } return gaps;
}
function renderAudit(){
  const dups=dupDetect(State.sales.map(s=>s.invoice_no).filter(Boolean));
  const gaps=numGaps(State.sales.map(s=>s.invoice_no));
  const orph=State.sales.filter(s=>!State.bank.some(b=>b.invoice_no===s.invoice_no)&&s.status!=="paid");
  const partial=State.sales.filter(s=>s.status==="partial");
  $("#aDup").textContent=dups.length; $("#aDupEx").textContent=(dups.slice(0,5).join(", "))||"‚Äî";
  $("#aGap").textContent=gaps.length; $("#aGapEx").textContent=(gaps.slice(0,3).map(g=>`${g[0]}‚Üí${g[1]}`).join(" ¬∑ "))||"‚Äî";
  $("#aOrph").textContent=orph.length; $("#aOrphEx").textContent=(orph.slice(0,3).map(o=>o.invoice_no).join(", "))||"‚Äî";
  $("#aPart").textContent=partial.length; $("#aPartEx").textContent=(partial.slice(0,3).map(o=>o.invoice_no).join(", "))||"‚Äî";
  // Table
  const tb=$("#aTbl tbody"); tb.innerHTML="";
  dups.forEach(x=>tb.insertAdjacentHTML("beforeend",`<tr><td><span class="badge">Duplicate</span></td><td class="mono">${x}</td><td>Invoice number repeats</td><td>Investigate/correct</td></tr>`));
  gaps.forEach(g=>tb.insertAdjacentHTML("beforeend",`<tr><td><span class="badge">Gap</span></td><td class="mono">${g[0]}‚Üí${g[1]}</td><td>Missing sequence</td><td>Confirm voids/missing</td></tr>`));
  orph.forEach(o=>tb.insertAdjacentHTML("beforeend",`<tr><td><span class="badge">Orphan</span></td><td class="mono">${o.invoice_no}</td><td>No matching bank payment</td><td>Chase/mark paid</td></tr>`));
  partial.forEach(o=>tb.insertAdjacentHTML("beforeend",`<tr><td><span class="badge">Partial</span></td><td class="mono">${o.invoice_no}</td><td>Partially paid</td><td>Reconcile remaining</td></tr>`));
  if(!tb.innerHTML) tb.innerHTML=`<tr><td colspan="4" class="succ">No issues found.</td></tr>`;
}

/* ===== Reconciliation ===== */
function guessInvFromText(t){ const m=String(t).match(/(INV-\d+|BILL-\d+)/i); return m?m[1].toUpperCase():""; }
function resetReconSuggestions(msg='Click "Auto-Reconcile" to generate suggestions.'){
  const box=$("#bSug");
  if(box) box.innerHTML=`<div class="note">${msg}</div>`;
}
function bankConceptText(bank){
  return normalizeMatchText([bank?.concept, bank?.details, bank?.description].join(" "));
}
function bankConceptKey(bank){
  return normalizeMatchKey([bank?.concept, bank?.details, bank?.description].join(" "));
}
function supplierNameVariants(inv){
  return [inv?.supplier, inv?.razon_social, inv?.sociedad, inv?.customer]
    .map(normalizeMatchText)
    .filter(Boolean);
}
function invoiceIdentifier(inv){
  return inv?.invoice_no || inv?.numero_factura || inv?.dc || "";
}
function invoiceMatchKey(inv){
  return normalizeMatchKey(invoiceIdentifier(inv));
}
function extractBankDcRefs(bank){
  if(!bank) return [];
  const sources=[bank.invoice_no, bank.details, bank.concept, bank.description];
  const refs=[];
  const seen=new Set();
  const capture=raw=>{
    const trimmed=String(raw??"").trim();
    if(!trimmed) return;
    const prefixed=/^dc/i.test(trimmed)?trimmed:`DC ${trimmed}`;
    const key=invKey(prefixed);
    if(!key || seen.has(key)) return;
    seen.add(key);
    refs.push({raw:prefixed.trim(),key,fuzzy:normalizeMatchKey(prefixed)});
  };
  const regex=/DC\s*[:\-]?\s*([A-Z0-9]+(?:[\/,;+][A-Z0-9]+)*)/gi;
  for(const source of sources){
    if(!source) continue;
    const sanitized=String(source).replace(/[()]/g," ");
    let matched=false;
    let match;
    while((match=regex.exec(sanitized))){
      matched=true;
      const block=match[1]||"";
      if(!block){
        capture(match[0]);
        continue;
      }
      block.split(/[\/,;+]/).forEach(part=>{
        const piece=part.trim();
        if(piece) capture(`DC ${piece}`);
      });
    }
    if(!matched && String(source).toUpperCase().includes("DC")){
      capture(source);
    }
  }
  return refs;
}
function bankDcReconciliationCheck(bank, supplierByDcKey, supplierByFuzzyKey, purchaseByInvoiceKey, purchaseByFuzzyKey){
  if(!bank) return null;
  const refs=extractBankDcRefs(bank);
  if(!refs.length) return null;
  const purchases=[];
  const seenPurchases=new Set();
  const pushPurchase=candidate=>{
    let added=false;
    if(Array.isArray(candidate)){
      candidate.forEach(item=>{ if(pushPurchase(item)) added=true; });
      return added;
    }
    if(candidate && !seenPurchases.has(candidate)){
      seenPurchases.add(candidate);
      purchases.push(candidate);
      added=true;
    }
    return added;
  };
  const missingRefs=[];
  for(const ref of refs){
    let supplierRows=supplierByDcKey.get(ref.key);
    if((!supplierRows || !supplierRows.length) && ref.fuzzy){
      supplierRows=supplierByFuzzyKey.get(ref.fuzzy);
    }
    if(supplierRows && supplierRows.length){
      for(const row of supplierRows){
        const purchaseKey=invKey(row.numero_factura||row.dc||"");
        let addedForRow=false;
        if(purchaseKey){
          const fromKey=purchaseByInvoiceKey.get(purchaseKey);
          if(fromKey) addedForRow=pushPurchase(fromKey)||addedForRow;
          const purchaseFuzzy=normalizeMatchKey(row.numero_factura||row.dc||"");
          if(purchaseFuzzy) addedForRow=pushPurchase(purchaseByFuzzyKey.get(purchaseFuzzy))||addedForRow;
        }
        if(!addedForRow){
          addedForRow=pushPurchase(purchaseByInvoiceKey.get(ref.key))||addedForRow;
          if(!addedForRow && ref.fuzzy){
            addedForRow=pushPurchase(purchaseByFuzzyKey.get(ref.fuzzy))||addedForRow;
          }
        }
      }
      continue;
    }
    const addedFromKey=pushPurchase(purchaseByInvoiceKey.get(ref.key));
    const addedFromFuzzy=ref.fuzzy ? pushPurchase(purchaseByFuzzyKey.get(ref.fuzzy)) : false;
    if(!addedFromKey && !addedFromFuzzy){
      missingRefs.push(ref);
    }
  }
  const total=purchases.reduce((sum,row)=>sum+Math.abs(invoiceAmountValue(row)),0);
  const bankAmt=Math.abs(num(bank.amount));
  let warningMessage="";
  if(missingRefs.length){
    const missingDisplay=missingRefs.map(ref=>ref.raw).join(", ");
    warningMessage=`FACTURA references ${missingDisplay} but no supplier invoice with that DC was found.`;
  }else if(Number.isFinite(bankAmt) && purchases.length && Math.abs(bankAmt-total)>0.01){
    const refsDisplay=refs.map(ref=>ref.raw).join(" + ");
    const totalText=fmt.format(total);
    const bankText=fmt.format(bankAmt);
    warningMessage=`FACTURA references ${refsDisplay} totaling ${totalText}, but bank amount is ${bankText}.`;
  }
  return {refs,purchases,missingRefs,total,warningMessage};
}
function invoiceAmountValue(inv){
  if(!inv) return 0;
  const candidates=[inv.amount, inv.importe_total, inv.base_amount];
  for(const val of candidates){
    const numVal=num(val);
    if(Number.isFinite(numVal) && Math.abs(numVal)>0.0001) return numVal;
  }
  const fallback=num(inv.amount);
  return Number.isFinite(fallback)?fallback:0;
}
const SUGGESTION_KEY_PROP="__reconKey";
function suggestionTargetKey(rec){
  if(!rec) return "null";
  const candidates=[invoiceIdentifier(rec), rec?.invoice_no, rec?.numero_factura, rec?.dc, rec?.id, rec?.reference];
  for(const val of candidates){
    const key=invKey(val);
    if(key) return key;
  }
  const idxP=State.purch.indexOf(rec);
  if(idxP>=0) return `purch#${idxP}`;
  const idxS=State.sales.indexOf(rec);
  if(idxS>=0) return `sales#${idxS}`;
  if(!rec[SUGGESTION_KEY_PROP]){
    rec[SUGGESTION_KEY_PROP]=`obj#${Math.random().toString(36).slice(2)}`;
  }
  return rec[SUGGESTION_KEY_PROP];
}
function describeSuggestionTarget(inv){
  if(!inv) return "";
  const name=[inv.supplier, inv.razon_social, inv.sociedad, inv.customer].find(Boolean) || "‚Äî";
  const id=invoiceIdentifier(inv) || inv.numero_factura || inv.dc || "‚Äî";
  const amt=fmt.format(Math.abs(invoiceAmountValue(inv)));
  return `${name} ‚Ä¢ ${id} ‚Ä¢ ${amt}`;
}
function describeSuggestionHeadline(suggestion){
  if(!suggestion) return "";
  if(suggestion.headline) return suggestion.headline;
  const total=fmt.format(Math.abs(suggestion.total ?? suggestion.targets.reduce((sum,rec)=>sum+Math.abs(invoiceAmountValue(rec)),0)));
  if(suggestion.targets.length>1){
    return `${suggestion.targets.length} invoices ‚Ä¢ Total ${total}`;
  }
  return describeSuggestionTarget(suggestion.targets[0]);
}

function addReconciliationKeyCandidates(value, keySet, fuzzySet){
  if(value==null) return;
  const raw=String(value).trim();
  if(!raw) return;
  const tokens=[raw];
  if(/[\\/,+;]/.test(raw)){
    raw.split(/[\\/,+;]/).forEach(part=>{
      const trimmed=part.trim();
      if(trimmed && !tokens.includes(trimmed)) tokens.push(trimmed);
    });
  }
  tokens.forEach(token=>{
    const key=invKey(token);
    if(key) keySet.add(key);
    const fuzzy=normalizeMatchKey(token);
    if(fuzzy) fuzzySet.add(fuzzy);
  });
}

function collectPurchasesForBankMatch(bank, inv){
  const keySet=new Set();
  const fuzzySet=new Set();
  const matches=[];
  const seen=new Set();
  const addVal=value=>addReconciliationKeyCandidates(value, keySet, fuzzySet);
  if(bank){
    addVal(bank.invoice_no);
    const refs=extractBankDcRefs(bank);
    refs.forEach(ref=>{
      if(ref.key) keySet.add(ref.key);
      if(ref.fuzzy) fuzzySet.add(ref.fuzzy);
      addVal(ref.raw);
    });
  }
  const seeds=[inv];
  seeds.forEach(rec=>{
    if(!rec) return;
    addVal(rec.invoice_no);
    addVal(rec.numero_factura);
    addVal(rec.dc);
    if(rec.supplier_details){
      addVal(rec.supplier_details.numero_factura);
      addVal(rec.supplier_details.dc);
    }
  });
  const consider=purchase=>{
    if(!purchase || seen.has(purchase)) return;
    seen.add(purchase);
    matches.push(purchase);
  };
  for(const purchase of State.purch){
    const values=[
      invoiceIdentifier(purchase),
      purchase.invoice_no,
      purchase.numero_factura,
      purchase.dc,
      purchase.supplier_details?.numero_factura,
      purchase.supplier_details?.dc
    ];
    const matched=values.some(val=>{
      if(!val) return false;
      const key=invKey(val);
      if(key && keySet.has(key)) return true;
      const fuzzy=normalizeMatchKey(val);
      return Boolean(fuzzy && fuzzySet.has(fuzzy));
    });
    if(matched) consider(purchase);
  }
  if(inv && State.purch.includes(inv)) consider(inv);
  return matches;
}

function collectDcRefsForSuggestion(bank, suggestion, purchases){
  const refs=new Map();
  const addRef=raw=>{
    if(raw==null) return;
    const extracted=extractBankDcRefs({invoice_no:raw});
    if(extracted && extracted.length){
      extracted.forEach(ref=>{
        const display=ref?.raw?ref.raw.replace(/\s+/g," ").toUpperCase():"";
        const key=display?invKey(display):null;
        if(key && !refs.has(key)) refs.set(key, display);
      });
      return;
    }
    const str=String(raw).trim();
    if(!str || !/DC/i.test(str)) return;
    const display=str.replace(/\s+/g," ").toUpperCase();
    const key=invKey(/^DC/i.test(display)?display:`DC ${display}`);
    if(key && !refs.has(key)) refs.set(key, key);
  };
  if(suggestion?.context?.refsDisplay){
    suggestion.context.refsDisplay.split(/\s*\+\s*/).forEach(part=>addRef(part));
  }
  extractBankDcRefs(bank).forEach(ref=>addRef(ref.raw));
  purchases.forEach(purchase=>{
    if(!purchase) return;
    addRef(purchase.dc);
    addRef(purchase.numero_factura);
    addRef(purchase.invoice_no);
    if(purchase.supplier_details){
      addRef(purchase.supplier_details.dc);
      addRef(purchase.supplier_details.numero_factura);
    }
  });
  return [...refs.values()];
}

function applyReconciliationMatch(bank, inv, explicitPurchases=[]){
  if(!bank) return;
  const matchDate=bankPrimaryDate(bank);
  const purchases=collectPurchasesForBankMatch(bank, inv);
  const seen=new Set(purchases);
  explicitPurchases.forEach(purchase=>{
    if(purchase && !seen.has(purchase)){
      seen.add(purchase);
      purchases.push(purchase);
    }
  });
  if(purchases.length){
    purchases.forEach(purchase=>{
      purchase.status="conciliado";
      if(matchDate && !purchase.paid_date) purchase.paid_date=matchDate;
      if(matchDate && !purchase.supplier_paid_date) purchase.supplier_paid_date=matchDate;
      purchase.supplier_payment_status="PAGADA";
      if(purchase._source==="supplier" && purchase.supplier_details){
        if(matchDate && !purchase.supplier_details.fecha_pago) purchase.supplier_details.fecha_pago=matchDate;
        purchase.supplier_details.estado_pago="PAGADA";
      }
    });
  }else if(inv && State.purch.includes(inv)){
    inv.status="conciliado";
    if(matchDate && !inv.paid_date) inv.paid_date=matchDate;
    if(matchDate && !inv.supplier_paid_date) inv.supplier_paid_date=matchDate;
    inv.supplier_payment_status="PAGADA";
    if(inv._source==="supplier" && inv.supplier_details){
      if(matchDate && !inv.supplier_details.fecha_pago) inv.supplier_details.fecha_pago=matchDate;
      inv.supplier_details.estado_pago="PAGADA";
    }
  }
  if(inv && State.sales.includes(inv)){
    inv.status="paid";
    if(matchDate && !inv.paid_date) inv.paid_date=matchDate;
  }
}
function findInvoiceByNumber(no){
  if(!no) return null;
  return State.purch.find(p=>p.invoice_no===no) || State.sales.find(s=>s.invoice_no===no);
}
function autoRecon(){
  const list=[];
  const seen=new Map();
  const dcChecks=new Map();
  const w=State.cfg.reconDays;
  const box=$("#bSug");
  if(!box) return;
  if(!State.bank.length){
    resetReconSuggestions('No bank movements yet. Import or add transactions to see suggestions.');
    return;
  }
  const bankIndex=new Map(); State.bank.forEach((b,i)=>bankIndex.set(b,i));
  const purchases=State.purch.map(p=>({
    rec:p,
    key:invoiceMatchKey(p),
    names:supplierNameVariants(p),
    amount:Math.abs(invoiceAmountValue(p)),
    date:p.date||""
  }));
  const sales=State.sales.map(s=>({
    rec:s,
    key:invoiceMatchKey(s),
    names:supplierNameVariants(s),
    amount:Math.abs(invoiceAmountValue(s)),
    date:s.date||""
  }));
  const purchaseByInvoiceKey=new Map();
  const purchaseByFuzzyKey=new Map();
  State.purch.forEach(p=>{
    const keys=[
      invoiceIdentifier(p),
      p.invoice_no,
      p.numero_factura,
      p.dc,
      p.supplier_details?.numero_factura,
      p.supplier_details?.dc
    ];
    keys.forEach(val=>{
      if(!val) return;
      const key=invKey(val);
      if(key){
        if(!purchaseByInvoiceKey.has(key)) purchaseByInvoiceKey.set(key,[]);
        purchaseByInvoiceKey.get(key).push(p);
      }
      const fuzzy=normalizeMatchKey(val);
      if(fuzzy){
        if(!purchaseByFuzzyKey.has(fuzzy)) purchaseByFuzzyKey.set(fuzzy,[]);
        purchaseByFuzzyKey.get(fuzzy).push(p);
      }
    });
  });
  const supplierByDcKey=new Map();
  const supplierByFuzzyKey=new Map();
  State.suppliers.forEach(row=>{
    const key=invKey(row.dc);
    if(key){
      if(!supplierByDcKey.has(key)) supplierByDcKey.set(key,[]);
      supplierByDcKey.get(key).push(row);
    }
    const fuzzy=normalizeMatchKey(row.dc);
    if(fuzzy){
      if(!supplierByFuzzyKey.has(fuzzy)) supplierByFuzzyKey.set(fuzzy,[]);
      supplierByFuzzyKey.get(fuzzy).push(row);
    }
  });
  const addSuggestion=(bank,targetsLike,score,method,opts={})=>{
    const bankId=bankIndex.get(bank);
    if(bankId==null) return;
    const targets=(Array.isArray(targetsLike)?targetsLike:[targetsLike]).filter(Boolean);
    if(!targets.length) return;
    const targetKeys=targets.map(rec=>suggestionTargetKey(rec)).sort().join("+");
    const supplierKeys=targets.map(rec=>normalizeMatchKey([rec?.supplier,rec?.razon_social,rec?.sociedad,rec?.customer].find(Boolean)||"")||"").sort().join("|");
    const groupKey=opts.group||method;
    const key=`${bankId}|${groupKey}|${targetKeys}|${supplierKeys}`;
    const total=opts.total ?? targets.reduce((sum,rec)=>sum+Math.abs(invoiceAmountValue(rec)),0);
    const existing=seen.get(key);
    if(existing){
      if(existing.score>=score) return;
      existing.score=score;
      existing.method=method;
      existing.targets=targets;
      existing.total=total;
      existing.context=opts.context||existing.context||null;
      existing.headline=opts.headline||existing.headline||null;
      return;
    }
    const suggestion={bank,targets,score,method,total,context:opts.context||null,headline:opts.headline||null};
    seen.set(key,suggestion);
    list.push(suggestion);
  };
  for(const b of State.bank){
    const dcCheck=bankDcReconciliationCheck(b, supplierByDcKey, supplierByFuzzyKey, purchaseByInvoiceKey, purchaseByFuzzyKey);
    if(dcCheck) dcChecks.set(b, dcCheck);
    if((b.match_status||"").toLowerCase()==="matched") continue;
    const conceptTxt=bankConceptText(b);
    const conceptKey=bankConceptKey(b);
    const bankAmt=Math.abs(num(b.amount));
    const bankDate=bankPrimaryDate(b);
    if(b.invoice_no){
      const inv=findInvoiceByNumber(b.invoice_no);
      if(inv) addSuggestion(b,inv,240,'FACTURA reference in bank row');
    }
    if(!b.invoice_no){
      const guess=guessInvFromText(`${b.description||""} ${b.concept||""} ${b.details||""}`.trim());
      if(guess){
        const inv=findInvoiceByNumber(guess);
        if(inv) addSuggestion(b,inv,210,'Invoice detected in description');
      }
    }
    if(dcCheck && dcCheck.purchases && dcCheck.purchases.length){
      const refsDisplay=dcCheck.refs.map(ref=>ref.raw).join(" + ");
      const amountPieces=dcCheck.purchases.map(rec=>fmt.format(Math.abs(invoiceAmountValue(rec))));
      const headlineParts=[refsDisplay];
      if(amountPieces.length){
        headlineParts.push(`${amountPieces.join(" + ")} = ${fmt.format(dcCheck.total)}`);
      }
      const headline=headlineParts.filter(Boolean).join(" ‚Ä¢ ");
      const dcGroupKeys=dcCheck.refs.map(ref=>ref.key||normalizeMatchKey(ref.raw)||ref.raw).filter(Boolean).sort().join('+');
      addSuggestion(b, dcCheck.purchases, 235, 'FACTURA DC match', {
        group:`dc:${dcGroupKeys}`,
        context:{refsDisplay, amountPieces, dcTotal:dcCheck.total},
        headline
      });
    }
    const pool=b.type==="credit"?sales:purchases;
    if(conceptKey){
      for(const cand of pool){
        if(!cand.key) continue;
        if(conceptKey.includes(cand.key)){
          addSuggestion(b,cand.rec,200,'Invoice reference in concept');
        }
      }
    }
    if(bankAmt>0){
      for(const cand of pool){
        if(!cand.amount) continue;
        if(Math.abs(bankAmt - Math.abs(cand.amount)) < 0.01){
          const invDate=cand.date;
          const days=(bankDate && invDate)?Math.abs((new Date(bankDate)-new Date(invDate))/(1000*3600*24)):null;
          if(days!=null && days>w) continue;
          const supplierHit=cand.names.some(name=>name && conceptTxt.includes(name));
          const invoiceHit=cand.key && conceptKey.includes(cand.key);
          const method=supplierHit
            ? 'Supplier name + amount match'
            : invoiceHit
              ? 'Invoice + amount match'
              : `Amount match (¬±${w} days)`;
          const scoreBase=150 + (supplierHit?40:invoiceHit?20:0);
          const score=scoreBase - (Number.isFinite(days)?days:0);
          addSuggestion(b,cand.rec,score,method);
        }
      }
    }
  }
  list.sort((a,b)=>b.score-a.score);
  const warningsRendered=new WeakSet();
  const renderWarningForBank=bank=>{
    const info=dcChecks.get(bank);
    if(!info || !info.warningMessage || warningsRendered.has(bank)) return;
    warningsRendered.add(bank);
    box.insertAdjacentHTML("beforeend", `<div class="dang">${htmlEsc(info.warningMessage)}</div>`);
  };
  box.innerHTML="";
  const top=list.slice(0,50);
  if(!top.length && ![...dcChecks.values()].some(info=>info && info.warningMessage)){
    resetReconSuggestions('No suggestions right now. Adjust dates or load more bank data.');
    return;
  }
  if(!top.length){
    dcChecks.forEach((info,bank)=>renderWarningForBank(bank));
  }
  top.forEach((s,i)=>{
    renderWarningForBank(s.bank);
    const headline=htmlEsc(describeSuggestionHeadline(s));
    const detailLines=s.targets.length>1
      ? s.targets.map(rec=>`<div class="tiny mono">${htmlEsc(describeSuggestionTarget(rec))}</div>`).join("")
      : "";
    const amountText=formatBankMoney(s.bank.amount, s.bank.amount_display) || fmt.format(num(s.bank.amount));
    const infoParts=[bankPrimaryDate(s.bank)||"‚Äî", amountText, s.bank.type||"", s.bank.concept||s.bank.details||s.bank.description||""].filter(Boolean);
    const infoText=infoParts.length?htmlEsc(infoParts.join(" ‚Ä¢ ")):"";
    box.insertAdjacentHTML("beforeend",
      `<div class="grp" style="justify-content:space-between">
        <div><b>${headline}</b>
          <div class="tiny">Method: ${htmlEsc(s.method)}</div>
          ${infoText?`<div class="tiny mono">${infoText}</div>`:""}
          ${detailLines}
        </div>
        <button class="btn" data-i="${i}" id="ap${i}">Apply</button>
      </div>`);
  });
  top.forEach((s,i)=> $("#ap"+i).onclick=()=>{
    const primaryTarget=s.targets[0]||null;
    const invId=primaryTarget?invoiceIdentifier(primaryTarget):null;
    const purchaseTargets=s.targets.filter(rec=>State.purch.includes(rec));
    const dcRefs=collectDcRefsForSuggestion(s.bank, s, purchaseTargets);
    if(dcRefs.length){
      s.bank.invoice_no=dcRefs.join(" + ");
    }else if(invId) {
      s.bank.invoice_no=invId;
    }else if(primaryTarget && primaryTarget.invoice_no){
      s.bank.invoice_no=primaryTarget.invoice_no;
    }
    s.bank.match_status="matched";
    applyReconciliationMatch(s.bank, primaryTarget, purchaseTargets);
    refreshAll();
    autoRecon();
    saveLS();
    $("#env").textContent="Reconciled (saved)";
  });
  dcChecks.forEach((info,bank)=>renderWarningForBank(bank));
}

/* ===== Reports ===== */
function runReport(){
  const t=$("#rType").value, from=$("#rFrom").value, to=$("#rTo").value;
  const add=(k,v)=> tb.insertAdjacentHTML("beforeend",`<tr><td>${k}</td><td class="mono">${v}</td></tr>`);
  const tb=$("#rTbl tbody"); tb.innerHTML="";
  if(t==="sales"){
    const rows=State.sales.filter(r=>(!from||r.date>=from)&&(!to||r.date<=to));
    add("Count", rows.length); add("Total", fmt.format(rows.reduce((a,b)=>a+num(b.amount),0)));
    add("Unpaid", fmt.format(rows.filter(r=>r.status!=="paid").reduce((a,b)=>a+num(b.amount),0)));
  }else if(t==="purch"){
    const rows=State.purch.filter(r=>(!from||r.date>=from)&&(!to||r.date<=to));
    const total=rows.reduce((a,b)=>a+num(b.amount),0);
    const unpaid=rows.filter(r=>r.status!=="paid").reduce((a,b)=>a+num(b.amount),0);
    const retention=rows.reduce((a,b)=>a+num(b.retention_amount),0);
    const baseTotal=rows.reduce((a,b)=>a+num(b.base_amount||b.amount),0);
    add("Count", rows.length);
    add("Total", fmt.format(total));
    add("Base (pre-tax)", fmt.format(baseTotal));
    add("Retention", fmt.format(retention));
    add("Unpaid", fmt.format(unpaid));
  }else if(t==="aging"){
    // reuse dashboard aging totals
    const now=new Date(); let cur=0,a30=0,a60=0,a90=0,a91=0;
    State.sales.forEach(s=>{
      if(s.status==="paid")return;
      const days=Math.floor((now - new Date(s.date))/(1000*3600*24));
      const amt=num(s.amount);
      if(days<=0) cur+=amt; else if(days<=30) a30+=amt; else if(days<=60) a60+=amt; else if(days<=90) a90+=amt; else a91+=amt;
    });
    add("Current", fmt.format(cur)); add("1‚Äì30", fmt.format(a30)); add("31‚Äì60", fmt.format(a60)); add("61‚Äì90", fmt.format(a90)); add("90+", fmt.format(a91));
    add("Total", fmt.format(cur+a30+a60+a90+a91));
  }else if(t==="bank"){
    const rows=State.bank.filter(r=>(!from||r.date>=from)&&(!to||r.date<=to));
    add("Count", rows.length); add("Net movement", fmt.format(rows.reduce((a,b)=>a+num(b.amount),0)));
    add("Unmatched", rows.filter(r=>r.match_status!=="matched").length);
  }
}
function exportReportCSV(){
  const rows=[...$("#rTbl tbody").querySelectorAll("tr")].map(tr=>({field:tr.children[0].textContent,value:tr.children[1].textContent}));
  csvDownload(`report_${$("#rType").value}_${today()}.csv`,[{label:"field",get:r=>r.field},{label:"value",get:r=>r.value}],rows);
}

function applyTheme(theme){
  const next=theme==="light"?"light":"dark";
  document.documentElement.setAttribute("data-theme", next);
  const btn=$("#themeToggle");
  if(btn){
    btn.textContent = next==="light"?"üåô Dark":"‚òÄÔ∏è Light";
    btn.setAttribute("aria-label", next==="light"?"Switch to dark mode":"Switch to light mode");
  }
  return next;
}
function loadTheme(){
  applyTheme(localStorage.getItem(THEME_KEY)||"dark");
}
function toggleTheme(){
  const current=document.documentElement.getAttribute("data-theme")==="light"?"light":"dark";
  const next=current==="light"?"dark":"light";
  localStorage.setItem(THEME_KEY, applyTheme(next));
}

/* ===== Events ===== */
$("#nav").addEventListener("click",e=>{ if(e.target.tagName!=="BUTTON")return; setActive(e.target.dataset.tab); });
["sQ","sFrom","sTo"].forEach(id=>$("#"+id).addEventListener("input", deb(()=>{
  State.filter.sales.q=$("#sQ").value.trim().toLowerCase();
  State.filter.sales.from=$("#sFrom").value;
  State.filter.sales.to=$("#sTo").value;
  render.sales();
})));
$("#sSt").onchange=()=>{ State.filter.sales.st=$("#sSt").value; render.sales(); };
["pQ","pFrom","pTo"].forEach(id=>$("#"+id).addEventListener("input", deb(()=>{
  State.filter.purch.q=$("#pQ").value.trim().toLowerCase();
  State.filter.purch.from=$("#pFrom").value;
  State.filter.purch.to=$("#pTo").value;
  render.purch();
})));
$("#pSt").onchange=()=>{ State.filter.purch.st=$("#pSt").value; render.purch(); };
["bQ","bFrom","bTo"].forEach(id=>$("#"+id).addEventListener("input", deb(()=>{
  State.filter.bank.q=$("#bQ").value.trim().toLowerCase();
  State.filter.bank.from=$("#bFrom").value;
  State.filter.bank.to=$("#bTo").value;
  render.bank();
})));
$("#bType").onchange=()=>{ State.filter.bank.type=$("#bType").value; render.bank(); };

// sorting
clickSort("sTbl","sales"); clickSort("pTbl","purch"); clickSort("bTbl","bank");

// sales CRUD
$("#sAdd").onclick=()=>openModal("sales","add");
$("#sEdit").onclick=()=> State.sel.sales? openModal("sales","edit", State.sel.sales) : alert("Select a row");
$("#sDel").onclick=()=>{ const sel=State.sel.sales; if(!sel) return alert("Select a row"); if(confirm("Delete selected?")){ State.sales=State.sales.filter(x=>x!==sel); State.sel.sales=null; refreshAll(); $("#env").textContent="Edited (unsaved)"; }};
// sales exports/open
$("#sCSV").onclick=()=>{ const rows=filtered.sales(); const hdr=[{label:"invoice_no",get:r=>r.invoice_no},{label:"date",get:r=>r.date},{label:"customer",get:r=>r.customer},{label:"amount",get:r=>num(r.amount)},{label:"status",get:r=>r.status},{label:"paid_date",get:r=>r.paid_date},{label:"pdf_link",get:r=>r.pdf_link},{label:"notes",get:r=>r.notes}]; csvDownload(`sales_${today()}.csv`,hdr,rows); };
$("#sPDF").onclick=()=> printTableAsPDF("Sales", $("#sTbl"));
$("#sOpenPDF").onclick=()=>{ const r=State.sel.sales; if(r&&r.pdf_link) window.open(r.pdf_link,"_blank"); else alert("Select a row with PDF link"); };

// purch CRUD
$("#pAdd").onclick=()=>openModal("purch","add");
$("#pEdit").onclick=()=> State.sel.purch? openModal("purch","edit", State.sel.purch) : alert("Select a row");
$("#pDel").onclick=()=>{ const sel=State.sel.purch; if(!sel) return alert("Select a row"); if(confirm("Delete selected?")){ State.purch=State.purch.filter(x=>x!==sel); State.sel.purch=null; refreshAll(); $("#env").textContent="Edited (unsaved)"; }};
const pColBtn=$("#pColBtn");
const pColMenu=$("#pColMenu");
if(pColBtn && pColMenu){
  const closeMenu=()=>{
    pColMenu.classList.remove("open");
    pColMenu.setAttribute("aria-hidden","true");
    pColBtn.setAttribute("aria-expanded","false");
  };
  const openMenu=()=>{
    renderPurchaseColumnMenu();
    pColMenu.classList.add("open");
    pColMenu.setAttribute("aria-hidden","false");
    pColBtn.setAttribute("aria-expanded","true");
  };
  pColBtn.addEventListener("click",e=>{
    e.stopPropagation();
    if(pColMenu.classList.contains("open")) closeMenu(); else openMenu();
  });
  document.addEventListener("click",e=>{
    if(!pColMenu.contains(e.target) && e.target!==pColBtn && !pColBtn.contains(e.target)) closeMenu();
  });
  pColMenu.addEventListener("click",e=> e.stopPropagation());
  pColMenu.addEventListener("change",e=>{
    if(e.target.matches("input[type=checkbox]")){
      const key=e.target.dataset.key;
      if(!key) return;
      const hide=!e.target.checked;
      if(hide){
        if(!State.hidden.purch.has(key)){
          if(visiblePurchaseColumns().length<=1){
            e.target.checked=true;
            return;
          }
          State.hidden.purch.add(key);
        }
      }else{
        State.hidden.purch.delete(key);
      }
      savePurchHiddenColumns();
      render.purch();
    }
  });
  const showAll=$("#pColShowAll");
  if(showAll) showAll.onclick=()=>{ State.hidden.purch.clear(); savePurchHiddenColumns(); render.purch(); };
}
// purch export/open
$("#pCSV").onclick=()=>{ const rows=filtered.purch(); const hdr=PURCHASE_COLUMNS.map(col=>({label:col.key,get:r=>purchaseCSVValue(col,r)})); csvDownload(`purchases_${today()}.csv`,hdr,rows); };
$("#pPDF").onclick=()=> printTableAsPDF("Purchases", $("#pTbl"));
$("#pOpenPDF").onclick=()=>{ const r=State.sel.purch; if(r&&r.pdf_link) window.open(r.pdf_link,"_blank"); else alert("Select a row with PDF link"); };

// bank CRUD
$("#bAdd").onclick=()=>openModal("bank","add");
$("#bEdit").onclick=()=> State.sel.bank? openModal("bank","edit", State.sel.bank) : alert("Select a row");
$("#bDel").onclick=()=>{ const sel=State.sel.bank; if(!sel) return alert("Select a row"); if(confirm("Delete selected?")){ State.bank=State.bank.filter(x=>x!==sel); State.sel.bank=null; refreshAll(); $("#env").textContent="Edited (unsaved)"; }};
$("#bCSV").onclick=()=>{ const rows=filtered.bank(); const hdr=[{label:"date",get:r=>r.date},{label:"description",get:r=>r.description},{label:"amount",get:r=>num(r.amount)},{label:"type",get:r=>r.type},{label:"invoice_no",get:r=>r.invoice_no},{label:"match_status",get:r=>r.match_status}]; csvDownload(`bank_${today()}.csv`,hdr,rows); };
$("#bPDF").onclick=()=> printTableAsPDF("Bank", $("#bTbl"));
$("#bRecon").onclick=autoRecon;

// reports
$("#rRun").onclick=runReport;
$("#rCSV").onclick=exportReportCSV;
$("#rPDF").onclick=()=> printTableAsPDF("Report", $("#rTbl"));

// audit exports
$("#aCSV").onclick=()=>{ const rows=[...$("#aTbl tbody").querySelectorAll("tr")].map(tr=>({cat:tr.children[0].innerText,ref:tr.children[1].innerText,detail:tr.children[2].innerText,action:tr.children[3].innerText})); const hdr=[{label:"category",get:r=>r.cat},{label:"reference",get:r=>r.ref},{label:"detail",get:r=>r.detail},{label:"suggested_action",get:r=>r.action}]; csvDownload(`audit_issues_${today()}.csv`,hdr,rows); };
$("#aPDF").onclick=()=> printTableAsPDF("Audit Issues", $("#aTbl"));

// data
$("#dSave").onclick=saveLS; $("#dLoad").onclick=loadLS; $("#dClear").onclick=()=>{ if(confirm("Clear LocalStorage data?")){ clearLS(); } };
$("#dExport").onclick=exportJSON;
$("#fImp").onchange=e=>{ const f=e.target.files?.[0]; if(f) importJSONFile(f); };
$("#supFile").onchange=e=>{ const f=e.target.files?.[0]; if(f){ importSupplierExcel(f); e.target.value=""; } };
$("#supTemplate").onclick=downloadSupplierTemplate;
$("#supClear").onclick=()=>{
  if(!State.suppliers.length) return;
  if(confirm("Clear imported supplier invoices?")){
    State.suppliers=[];
    syncPurchFromSuppliers();
    refreshAll();
    $("#env").textContent="Supplier data cleared";
  }
};
$("#bankFile").onchange=e=>{ const f=e.target.files?.[0]; if(f){ importBankExcel(f); e.target.value=""; } };
$("#bankClear").onclick=()=>{
  const hasImported=State.bank.some(b=>b._source===BANK_IMPORT_SOURCE);
  if(!hasImported){ alert("No imported bank transactions to clear."); return; }
  if(confirm("Clear imported bank transactions?")){
    State.bank=State.bank.filter(b=>b._source!==BANK_IMPORT_SOURCE);
    State.sel.bank=null;
    refreshAll();
    $("#env").textContent="Imported bank data cleared";
  }
};

// theme
$("#themeToggle").onclick=toggleTheme;

/* ===== Init ===== */
function init(){
  loadTheme();
  // Default from LocalStorage or seed
  loadLS();
  // Ensure filters start clear so all records are visible
  ["sFrom","sTo","pFrom","pTo","bFrom","bTo","rFrom","rTo"].forEach(id=>{
    const el=$("#"+id);
    if(el) el.value="";
  });
  clickSort("sTbl","sales"); clickSort("pTbl","purch"); clickSort("bTbl","bank");
}
init();
</script>
</body>
</html>
